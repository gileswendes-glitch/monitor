<!DOCTYPE html>
<html>
<head>
    <title>KHS IT School Monitor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- CORE LAYOUT --- */
        body { margin: 0; background: #121212; display: flex; font-family: 'Inter', 'Segoe UI', sans-serif; overflow: hidden; height: 100vh; color: #e0e0e0; }
        
        .sidebar { width: 320px; background: #1e1e1e; display: flex; flex-direction: column; padding: 25px; box-shadow: 0 0 30px rgba(0,0,0,0.5); z-index: 2000; }
        #sidebar-left { border-right: 1px solid #333; }
        #sidebar-right { border-left: 1px solid #333; }
        #main-content { flex-grow: 1; display: flex; flex-direction: column; background: #000; }

        /* --- CARDS & PANELS --- */
        .card { background: #252525; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        
        /* LEFT SIDEBAR STACKING FIX */
        .card-speed { border-top: 3px solid #4db8ff; flex: 0 0 auto; } /* Auto height */
        .card-cloud { border-top: 3px solid #28a745; flex: 0 0 auto; height: 180px; } /* Fixed height */
        .card-local { border-top: 3px solid #ffc107; flex: 1; min-height: 0; } /* Fills remaining space */
        
        /* RIGHT SIDEBAR STACKING */
        .card-firewall { border-top: 3px solid #fd7e14; min-height: 160px; flex: 0 0 auto; }
        .card-hardware { border-top: 3px solid #e83e8c; flex: 0 0 auto; } 
        .card-nvr { border-top: 3px solid #6f42c1; flex: 0 0 auto; }      
        .card-switch { border-top: 3px solid #17a2b8; flex: 1; min-height: 0; }     
        .card-printer { border-top: 3px solid #0d6efd; flex: 1; min-height: 0; }      

        /* TEXT & STATS */
        .card h2 { margin: 0 0 10px 0; font-size: 13px; color: #888; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; }
        .big-stat { font-size: 56px; font-weight: 300; color: #fff; letter-spacing: -2px; line-height: 1; }
        .unit { font-size: 13px; color: #666; font-weight: 500; margin-top: 5px; display: block; }
        
        /* SCROLLABLE LISTS */
        .list-window { overflow-y: auto; flex-grow: 1; padding-right: 5px; }
        .list-window::-webkit-scrollbar { width: 4px; }
        .list-window::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }

        /* LIST ITEMS */
        .service-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #333; font-size: 13px; color: #ccc; }
        
        /* DOTS */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .online { background: #00d26a; box-shadow: 0 0 8px rgba(0, 210, 106, 0.4); }
        .amber { background: #ffc107; box-shadow: 0 0 8px rgba(255, 193, 7, 0.6); animation: pulse-amber 2s infinite; }
        .offline { background: #f8312f; box-shadow: 0 0 10px rgba(248, 49, 47, 0.6); animation: flash-red 0.8s infinite alternate; }
        
        /* FIREWALL SPECIFIC */
        .fw-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; border-bottom: 1px solid #333; padding-bottom: 4px; }
        .fw-label { color: #888; }
        .fw-val { color: #fff; font-weight: 600; text-align: right; }
        .fw-desc { font-size: 11px; color: #666; line-height: 1.4; margin-top: 5px; max-height: 40px; overflow: hidden; }

        @keyframes pulse-amber { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        @keyframes flash-red { from { opacity: 1; box-shadow: 0 0 10px rgba(248, 49, 47, 0.8); } to { opacity: 0.3; box-shadow: 0 0 2px rgba(248, 49, 47, 0.2); } }

        /* HEADER & MAP */
        .page-header { background: rgba(30, 30, 30, 0.9); backdrop-filter: blur(10px); color: #fff; padding: 15px 30px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; z-index: 10; font-size: 20px; flex-shrink: 0; }
        
        .badge { font-size: 11px; font-weight: bold; padding: 5px 10px; border-radius: 4px; text-transform: uppercase; letter-spacing: 1px; margin-right: 15px; }
        .badge-local { background: rgba(0, 210, 106, 0.15); color: #00d26a; border: 1px solid #00d26a; }
        .badge-cloud { background: rgba(253, 126, 20, 0.15); color: #fd7e14; border: 1px solid #fd7e14; }

        #map-wrapper { flex-grow: 1; position: relative; width: 100%; height: 100%; }
        #map { height: 100%; width: 100%; background: #121212; }
        #map-title { position: absolute; top: 20px; right: 20px; background: rgba(20, 20, 20, 0.85); color: #e0e0e0; padding: 8px 20px; border-radius: 6px; z-index: 1000; backdrop-filter: blur(5px); border: 1px solid #444; }
        .version-footer { margin-top: auto; text-align: center; font-size: 11px; color: #444; padding-top: 20px; border-top: 1px solid #2a2a2a; }

        /* --- MOBILE RESPONSIVE TWEAKS --- */
        @media screen and (max-width: 900px) {
            body { 
                flex-direction: column; /* Stack vertically */
                overflow-y: auto;       /* Allow page scrolling */
                height: auto;           /* Remove fixed height */
            }
            .sidebar { 
                width: 100%;            /* Full width */
                height: auto;           /* Fit content */
                box-shadow: none;       
                padding: 15px;
                box-sizing: border-box; /* Prevent padding overflow */
                order: 2;               /* Move below header */
            }
            #sidebar-left { border-right: none; border-bottom: 1px solid #333; }
            #sidebar-right { border-left: none; }
            
            #main-content {
                order: 1;               /* Header stays on top */
                flex-grow: 0;           /* Don't expand */
            }

            /* HIDE MAP ON MOBILE */
            #map-wrapper { display: none; }
            .page-header { position: sticky; top: 0; }
            
            /* ADJUST CARDS FOR MOBILE SCROLLING */
            .list-window { max-height: 250px; } /* Prevent lists from being too long */
            .card-local, .card-switch, .card-printer { flex: none; height: auto; }
        }
    </style>
</head>
<body>

    <div id="sidebar-left" class="sidebar">
        <div class="card card-speed">
            <h2>Internet Health</h2>
            <div style="text-align: center; padding: 15px 0;">
                <div class="big-stat" id="net-ping">--</div>
                <span class="unit">ms LATENCY</span>
            </div>
        </div>

        <div class="card card-cloud">
            <h2>Cloud Services</h2>
            <div id="cloud-window" class="list-window"></div>
        </div>

        <div class="card card-local">
            <h2>Local Servers</h2>
            <div id="server-window" class="list-window"></div>
        </div>
        
        <div class="version-footer">KINGSBURY MONITOR v2.4</div>
    </div>

    <div id="main-content">
        <div class="page-header">
            <div style="display:flex; align-items:center;">
                <div id="conn-badge" class="badge badge-local">LOCAL</div>
                <span>Kingsbury IT Monitoring</span>
            </div>
            <span id="clock" style="font-size:14px; color:#888;"></span>
        </div>
        
        <div id="map-wrapper"><div id="map-title">Loading...</div><div id="map"></div></div>
    </div>

    <div id="sidebar-right" class="sidebar">
        <div class="card card-firewall">
            <h2>Firewall Status</h2>
            <div id="firewall-content" style="padding-top: 5px;"></div>
        </div>
        
        <div class="card card-hardware">
            <h2>Physical Hardware</h2>
            <div id="hardware-list" class="list-window"></div>
        </div>
        
        <div class="card card-nvr">
            <h2>NVRs</h2>
            <div id="nvr-list" class="list-window"></div>
        </div>

        <div class="card card-switch">
            <h2>Switch Hardware</h2>
            <div id="switch-window" class="list-window"></div>
        </div>
        
        <div class="card card-printer">
            <h2>Printers</h2>
            <div id="printer-window" class="list-window"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // 1. CLOUD vs LOCAL DETECTION
        const isCloud = window.location.hostname.includes('render') || window.location.hostname.includes('herokuapp');
        const badge = document.getElementById('conn-badge');
        if (isCloud) {
            badge.innerText = "CLOUD VIEW";
            badge.className = "badge badge-cloud";
        } else {
            badge.innerText = "LOCAL VIEW";
            badge.className = "badge badge-local";
        }

        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }, 1000);

        const maps = [
            { id: 'T-G.PNG', name: 'T Site - Ground' }, { id: 'T-1.PNG', name: 'T Site - 1st Floor' },
            { id: 'T-M.PNG', name: 'T Site - Mezzanine' }, { id: 'K-G.PNG', name: 'K Site - Ground' },
            { id: 'K-1.PNG', name: 'K Site - 1st Floor' }, { id: 'K-2.PNG', name: 'K Site - 2nd Floor' }
        ];

        var map = L.map('map', { crs: L.CRS.Simple, minZoom: -2, zoomControl: false, attributionControl: false });
        var devicesLayer = L.layerGroup().addTo(map);
        var currentMapLayer;
        let currentMapIndex = 0;

        function loadMap(index) {
            // Safety: If map wrapper is hidden (mobile), don't load heavy images
            if (window.getComputedStyle(document.getElementById('map-wrapper')).display === 'none') return;

            const config = maps[index];
            document.getElementById('map-title').innerText = config.name;
            var img = new Image(); 
            img.src = config.id; 
            
            img.onload = function() {
                var w = this.width; var h = this.height;
                if (currentMapLayer) map.removeLayer(currentMapLayer);
                var bounds = [[0, 0], [h, w]]; 
                currentMapLayer = L.imageOverlay(config.id, bounds).addTo(map);
                map.fitBounds(bounds);
            }
        }

        async function updateDashboard() {
            try {
                const res = await fetch('/api/devices');
                const devices = await res.json();
                
                let cloudH='', serverH='', hardwareH='', nvrH='', switchH='', prtH='';
                let firewallHTML = '';

                devices.sort((a, b) => a.name.localeCompare(b.name));

                devices.forEach(d => {
                    let statusClass = d.status === 'online' ? 'online' : (d.status === 'amber' ? 'amber' : 'offline');
                    const itemHTML = `<div class="service-item"><span>${d.name}</span><div class="status-dot ${statusClass}"></div></div>`;

                    if (d.type === 'service') cloudH += itemHTML;
                    else if (d.type === 'server') serverH += itemHTML;
                    else if (d.type === 'hardware') hardwareH += itemHTML;
                    else if (d.type === 'nvr') nvrH += itemHTML;
                    else if (d.type === 'switch_hw') switchH += itemHTML;
                    else if (d.type === 'printer') prtH += itemHTML;
                    
                    else if (d.type === 'firewall') {
                        const det = d.details || {};
                        const sysName = det.sysName || d.name;
                        const uptime = det.uptime || '--';
                        let desc = det.desc || 'No System Info';
                        desc = desc.replace(/^Linux\s+\S+\s+/, ''); 

                        firewallHTML += `
                            <div style="margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px;">
                                <div class="fw-row"><span class="fw-label">Device Name</span><span class="fw-val">${sysName}</span></div>
                                <div class="fw-row"><span class="fw-label">Status</span><div class="status-dot ${statusClass}"></div></div>
                                <div class="fw-row"><span class="fw-label">Uptime</span><span class="fw-val" style="color:#00d26a;">${uptime}</span></div>
                                <div class="fw-desc">${desc}</div>
                            </div>
                        `;
                    }
                });

                document.getElementById('cloud-window').innerHTML = cloudH;
                document.getElementById('server-window').innerHTML = serverH;
                document.getElementById('switch-window').innerHTML = switchH;
                document.getElementById('printer-window').innerHTML = prtH;
                document.getElementById('hardware-list').innerHTML = hardwareH;
                document.getElementById('nvr-list').innerHTML = nvrH;
                
                const fwContainer = document.getElementById('firewall-content');
                if (firewallHTML) fwContainer.innerHTML = firewallHTML;
                else fwContainer.innerHTML = '<div style="text-align: center; color: #666; font-size: 13px;">No Firewall Configured</div>';

                // Map Update (Only if visible)
                if (window.getComputedStyle(document.getElementById('map-wrapper')).display !== 'none') {
                    devicesLayer.clearLayers();
                    devices.forEach(d => {
                        // FIX: Crash Protection (Check for coordinates existence)
                        if (!d.map_coordinates || typeof d.map_coordinates.x === 'undefined') return;

                        // FIX: Show ALL device types, not just 'switch'
                        if (d.floor_id === maps[currentMapIndex].id) {
                            
                            let color = '#f8312f'; // Default Red
                            if (d.status === 'online') color = '#00d26a'; // Green
                            else if (d.status === 'amber') color = '#ffc107'; // Amber

                            L.circleMarker([d.map_coordinates.y, d.map_coordinates.x], {
                                color: 'transparent', fillColor: color, fillOpacity: 0.9, radius: 8
                            }).addTo(devicesLayer).bindTooltip(d.name, {permanent: false, direction: 'top'});
                        }
                    });
                }
            } catch (e) { console.log(e); }

            try {
                const sRes = await fetch('/api/status');
                const speed = await sRes.json();
                document.getElementById('net-ping').innerText = speed.ping || '--';
                const pVal = parseInt(speed.ping);
                const pElem = document.getElementById('net-ping');
                if(pVal < 50) pElem.style.color = '#00d26a'; 
                else if(pVal < 100) pElem.style.color = '#ffc107'; 
                else pElem.style.color = '#f8312f'; 
            } catch (e) {}
        }

        setInterval(() => { currentMapIndex = (currentMapIndex + 1) % maps.length; loadMap(currentMapIndex); updateDashboard(); }, 15000); 
        loadMap(0); updateDashboard(); setInterval(updateDashboard, 5000); 
    </script>
</body>
</html>
