<!DOCTYPE html>
<html>
<head>
    <title>KHS IT Monitor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #121212; display: flex; font-family: 'Inter', 'Segoe UI', sans-serif; overflow: hidden; height: 100vh; color: #e0e0e0; }
        .sidebar { width: 320px; background: #1e1e1e; display: flex; flex-direction: column; padding: 25px; box-shadow: 0 0 30px rgba(0,0,0,0.5); z-index: 2000; overflow-y: auto; scrollbar-width: none; }
        .sidebar::-webkit-scrollbar { display: none; }
        #sidebar-left { border-right: 1px solid #333; }
        #sidebar-right { border-left: 1px solid #333; }
        #main-content { flex-grow: 1; display: flex; flex-direction: column; background: #000; }

        .card { background: #252525; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; flex-direction: column; flex-shrink: 0; }
        
        .card-cloud { border-top: 3px solid #28a745; min-height: 100px; }
        .card-local { border-top: 3px solid #ffc107; }
        .card-firewall { border-top: 3px solid #fd7e14; }
        .card-hardware { border-top: 3px solid #e83e8c; } 
        .card-nvr { border-top: 3px solid #6f42c1; }      
        .card-switch { border-top: 3px solid #17a2b8; }     
        .card-printer { border-top: 3px solid #0d6efd; }   
        .card-telephone { border-top: 3px solid #00bcd4; }
        .card-wap { border-top: 3px solid #3f51b5; }
        .card-access { border-top: 3px solid #9c27b0; }
        .card-cctv { border-top: 3px solid #f44336; }

        .card h2 { margin: 0 0 10px 0; font-size: 13px; color: #888; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; }
        .big-stat { font-size: 48px; font-weight: 300; color: #fff; letter-spacing: -2px; line-height: 1; }
        .unit { font-size: 13px; color: #666; font-weight: 500; margin-top: 5px; display: block; }
        
        .list-window { overflow-y: auto; padding-right: 5px; max-height: 320px; min-height: 30px; position: relative; scrollbar-width: none; }
        .list-window::-webkit-scrollbar { display: none; }

        .service-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #333; font-size: 13px; color: #ccc; }
        .service-sub { font-size: 11px; color: #777; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        
        .status-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .online { background: #00d26a; box-shadow: 0 0 8px rgba(0, 210, 106, 0.4); }
        .amber { background: #ffc107; box-shadow: 0 0 8px rgba(255, 193, 7, 0.6); animation: pulse-amber 2s infinite; }
        .offline { background: #f8312f; box-shadow: 0 0 10px rgba(248, 49, 47, 0.6); animation: flash-red 0.8s infinite alternate; }

        @keyframes flash-green-amber {
            0% { background-color: #00d26a; box-shadow: 0 0 8px #00d26a; }
            50% { background-color: #ffc107; box-shadow: 0 0 8px #ffc107; }
            100% { background-color: #00d26a; box-shadow: 0 0 8px #00d26a; }
        }
        .flash-monitor { animation: flash-green-amber 2s infinite; }

        /* BARS */
        .stat-container { margin-top: 6px; width: 100%; }
        .stat-row { display: flex; align-items: center; margin-bottom: 3px; }
        .stat-label { width: 30px; font-size: 10px; color: #888; }
        .stat-track { flex: 1; height: 5px; background: #333; border-radius: 3px; overflow: hidden; }
        .stat-fill { height: 100%; width: 0%; transition: width 0.5s; }
        .fill-cpu { background: #3498db; }
        .fill-ram { background: #9b59b6; }
        .fill-disk { background: #f1c40f; }
        
        .sub-text { font-size: 11px; color: #aaa; display: block; margin-top: 2px; }
    </style>
</head>
<body>
    <div id="sidebar-left" class="sidebar">
        <div class="card card-firewall">
            <h2>Firewall & Internet</h2>
            <div style="text-align: center; padding-bottom: 15px; border-bottom: 1px solid #333; margin-bottom: 10px;">
                <span class="big-stat" id="net-ping">--</span>
                <span class="unit" style="display:inline; margin-left:10px;">ms LATENCY</span>
            </div>
            <div id="firewall-content"></div>
        </div>
        <div class="card card-cloud"><h2>Cloud</h2><div id="cloud-window"></div></div>
        <div class="card card-local"><h2>Servers</h2><div id="server-window"></div></div>
        <div class="card card-nvr"><h2>NVRs</h2><div id="nvr-list"></div></div>
    </div>

    <div id="main-content">
        <div class="page-header">
            <div style="display:flex; align-items:center;">
                <div id="conn-badge" class="badge badge-local">LOCAL</div>
                <span>Kingsbury IT Monitoring</span>
            </div>
            <span id="clock" style="font-size:14px; color:#888;"></span>
        </div>
        <div id="map-wrapper">
            <div id="map-title">Loading...</div>
            <div id="map-controls">
                <button class="control-btn" id="pause-btn" onclick="togglePause()">‚è∏Ô∏è Pause</button>
                <button class="control-btn" onclick="nextMap()">‚è≠Ô∏è Next</button>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <div id="sidebar-right" class="sidebar">
        <div class="card card-printer">
            <h2>Printers</h2>
            <div id="printer-window" class="list-window"></div>
        </div>
        
        <div class="card card-cctv">
            <h2>CCTV Cameras</h2>
            <div id="cctv-list" class="list-window"></div>
        </div>
        <div class="card card-switch">
            <h2>Switches</h2>
            <div id="switch-window" class="list-window"></div>
        </div>
        <div class="card card-wap">
            <h2>Wireless APs</h2>
            <div id="wap-list" class="list-window"></div>
        </div>
        <div class="card card-telephone">
            <h2>Telephones</h2>
            <div id="tel-list" class="list-window"></div>
        </div>
        <div class="card card-access">
            <h2>Access Control</h2>
            <div id="access-list" class="list-window"></div>
        </div>
        <div class="card card-hardware">
            <h2>Misc Hardware</h2>
            <div id="hardware-list" class="list-window"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const isCloud = window.location.hostname.includes('render') || window.location.hostname.includes('herokuapp');
        const badge = document.getElementById('conn-badge');
        if (isCloud) { badge.innerText = "CLOUD VIEW"; badge.className = "badge badge-cloud"; }
        else { badge.innerText = "LOCAL VIEW"; badge.className = "badge badge-local"; }

        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }, 1000);

        // --- MAP SETUP ---
        const maps = [
            { id: 'T-G.PNG', name: 'T Site - Ground' }, { id: 'T-1.PNG', name: 'T Site - 1st Floor' },
            { id: 'T-M.PNG', name: 'T Site - Mezzanine' }, { id: 'K-G.PNG', name: 'K Site - Ground' },
            { id: 'K-1.PNG', name: 'K Site - 1st Floor' }, { id: 'K-2.PNG', name: 'K Site - 2nd Floor' }
        ];

        var map = L.map('map', { crs: L.CRS.Simple, minZoom: -2, zoomControl: false, attributionControl: false });
        var devicesLayer = L.layerGroup().addTo(map);
        var currentMapLayer;
        let currentMapIndex = 0;
        let isPaused = false;
        let mapTimer;

        // --- MAP FUNCTIONS ---
        function loadMap(index) {
            if (window.getComputedStyle(document.getElementById('map-wrapper')).display === 'none') return;
            const config = maps[index];
            document.getElementById('map-title').innerText = config.name;
            var img = new Image(); img.src = config.id; 
            img.onload = function() {
                var w = this.width; var h = this.height;
                if (currentMapLayer) map.removeLayer(currentMapLayer);
                var bounds = [[0, 0], [h, w]]; 
                currentMapLayer = L.imageOverlay(config.id, bounds).addTo(map);
                map.fitBounds(bounds);
            }
        }
        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('pause-btn');
            if(isPaused) { btn.innerText = "‚ñ∂Ô∏è Play"; btn.classList.add('paused'); }
            else { btn.innerText = "‚è∏Ô∏è Pause"; btn.classList.remove('paused'); updateDashboard(); }
        }
        function nextMap() {
            currentMapIndex = (currentMapIndex + 1) % maps.length;
            loadMap(currentMapIndex);
            updateDashboard();
        }
        function startMapTimer() {
            mapTimer = setInterval(() => { 
                if(!isPaused) { nextMap(); }
            }, 15000);
        }
        
        function getPopupContent(d) {
            const timeStr = d.updatedAt ? new Date(d.updatedAt).toLocaleTimeString() : (d.lastSeen ? new Date(d.lastSeen).toLocaleTimeString() : "Just now");
            let statusColor = d.status === 'online' ? '#00d26a' : (d.status === 'amber' ? '#ffc107' : '#f8312f');
            let info = '';
            if(d.details) {
                if(d.details.note) info = `<div style="margin-top:6px; font-style:italic; color:#ddd; font-weight:500;">"${d.details.note}"</div>`;
                else if(d.details.error) info = `<div style="margin-top:6px; color:#ff6b6b; font-weight:bold;">‚ö†Ô∏è ${d.details.error}</div>`;
                if(d.details.uptime) info += `<div style="margin-top:4px; font-size:10px; color:#aaa;">Uptime: ${d.details.uptime}</div>`;
            }
            return `<div style="text-align:center; min-width: 140px;">
                    <div style="font-weight:700; font-size:14px; margin-bottom:4px; color:#fff;">${d.name || 'Unknown'}</div>
                    <div style="font-size:11px; color:#aaa; margin-bottom:6px;">${d.ip}</div>
                    <div style="background:${statusColor}; color:#000; padding:3px 8px; border-radius:4px; display:inline-block; font-weight:700; font-size:11px; text-transform:uppercase;">${d.status}</div>
                    ${info}
                    <div style="font-size:10px; color:#666; margin-top:10px; border-top:1px solid #444; padding-top:5px;">üïí Last Check: ${timeStr}</div></div>`;
        }

        async function updateDashboard() {
            try {
                const res = await fetch('/api/devices');
                const devices = await res.json();
                
                let sH='', wH='', saH='', prH='', nvrH='', clH='', swH='', telH='', accH='', fwH='';
                const oneDayAgo = new Date(Date.now() - 86400000);

                // FIXED: Prevent crash if name is missing (undefined)
                devices.sort((a,b) => (a.name || 'Unknown').localeCompare(b.name || 'Unknown'));

                devices.forEach(d => {
                    let statusClass = d.status === 'online' ? 'online' : (d.status === 'amber' ? 'amber' : 'offline');
                    let staleIcon = '';

                    if (d.last_seen) {
                        const timeSince = Date.now() - new Date(d.last_seen).getTime();
                        if (timeSince > 600000) staleIcon = '<span title="Data >10m old" style="margin-left:5px; font-size:12px;">‚ö†Ô∏è</span>';
                    }

                    if (d.type !== 'printer' && d.status === 'online' && d.last_issue && new Date(d.last_issue) > oneDayAgo) {
                        statusClass = 'flash-monitor';
                    }
                    const dot = `<div class="status-dot ${statusClass}"></div>`;
                    const type = (d.type || '').toLowerCase();
                    const dName = d.name || 'Unknown Device';

                    // --- SERVERS (UPTIME IN HEADER) ---
                    if (type === 'server') {
                        let statsHTML = '';
                        let uptimeHTML = '';

                        if (d.details && d.details.cpu !== undefined && d.details.cpu !== null) {
                            let cpu = parseInt(d.details.cpu)||0, ram = parseInt(d.details.ram)||0, disk = parseInt(d.details.disk)||0;
                            
                            // Generate Uptime HTML
                            if(d.details.uptime) {
                                uptimeHTML = `<span style="font-size:11px; color:#888; font-weight:normal; margin-left:8px;">${d.details.uptime}</span>`;
                            }

                            statsHTML = `
                            <div class="stat-container">
                                <div class="stat-row"><span class="stat-label">CPU</span><div class="stat-track"><div class="stat-fill fill-cpu" style="width:${cpu}%"></div></div></div>
                                <div class="stat-row"><span class="stat-label">RAM</span><div class="stat-track"><div class="stat-fill fill-ram" style="width:${ram}%"></div></div></div>
                                <div class="stat-row"><span class="stat-label">HDD</span><div class="stat-track"><div class="stat-fill fill-disk" style="width:${disk}%"></div></div></div>
                            </div>`;
                        } else statsHTML = `<span class="sub-text">${d.status==='online'?'SNMP Unreachable':'Offline'}</span>`;
                        
                        sH += `<div class="service-item" style="flex-direction:column; align-items:stretch; padding:10px 0;"><div style="display:flex; justify-content:space-between; align-items:center;"><div style="display:flex; align-items:center;"><span style="font-weight:600;">${dName}${staleIcon}</span>${uptimeHTML}</div><div class="status-dot ${statusClass}"></div></div>${statsHTML}</div>`;
                    }
                    // --- FIREWALL ---
                    else if (type === 'firewall') {
                        let statsHTML = '';
                        const det = d.details || {};
                        
                        let uptime = (det.uptime) ? `<span style="font-size:11px; color:#666; margin-left:8px; font-weight:normal;">${det.uptime}</span>` : '';

                        if (det.ram) {
                            let ram = parseInt(det.ram)||0, disk = parseInt(det.disk)||0;
                            statsHTML = `
                            <div class="stat-container" style="margin-top:8px;">
                                <div class="stat-row"><span class="stat-label">RAM</span><div class="stat-track"><div class="stat-fill fill-ram" style="width:${ram}%"></div></div></div>
                                <div class="stat-row"><span class="stat-label">HDD</span><div class="stat-track"><div class="stat-fill fill-disk" style="width:${disk}%"></div></div></div>
                            </div>`;
                        } else {
                            statsHTML = `<span class="sub-text">${det.sysName || ''}</span>`;
                        }
                        
                        fwH += `<div class="service-item" style="flex-direction:column; align-items:stretch; padding:10px 0;"><div style="display:flex; justify-content:space-between; align-items:center;"><div style="display:flex; align-items:center;"><span style="font-weight:600;">${dName}</span>${uptime}</div>${dot}</div>${statsHTML}</div>`;
                    }
                    // --- OTHERS ---
                    else if (type === 'printer') prH += `<div class="service-item"><div class="item-header"><b>${dName}</b>${dot}</div><span class="sub-text">${d.details?.note||'Ready'}</span></div>`;
                    else if (type === 'wap') wH += `<div class="service-item"><div class="item-header"><b>${dName}</b>${dot}</div><span class="sub-text" style="color:#3498db;font-weight:bold;">${d.details?.note||''}</span></div>`;
                    else if (type === 'nvr') nvrH += `<div class="service-item"><div class="item-header"><b>${dName}</b>${dot}</div></div>`;
                    else if (type === 'san' || type === 'hardware') saH += `<div class="service-item"><div class="item-header"><b>${dName}</b>${dot}</div><span class="sub-text">${d.details?.note||''}</span></div>`;
                    else if (type === 'switch') swH += `<div class="service-item"><div class="item-header"><b>${dName}</b>${dot}</div></div>`;
                    else if (type === 'telephone') telH += `<div class="service-item"><div class="item-header"><b>${dName}</b>${dot}</div></div>`;
                    else if (type === 'access_control') accH += `<div class="service-item"><div class="item-header"><b>${dName}</b>${dot}</div></div>`;
                    else if (type === 'service') clH += `<div class="service-item"><div class="item-header"><b>${dName}</b>${dot}</div></div>`;
                });
                
                document.getElementById('server-window').innerHTML = sH;
                document.getElementById('printer-window').innerHTML = prH;
                document.getElementById('wap-list').innerHTML = wH;
                document.getElementById('hardware-list').innerHTML = saH;
                document.getElementById('nvr-list').innerHTML = nvrH;
                document.getElementById('cloud-window').innerHTML = clH;
                document.getElementById('switch-window').innerHTML = swH;
                document.getElementById('tel-list').innerHTML = telH;
                document.getElementById('access-list').innerHTML = accessH;
                document.getElementById('firewall-content').innerHTML = fwH;

                // --- MAP ICONS ---
                if (!isPaused && window.getComputedStyle(document.getElementById('map-wrapper')).display !== 'none') {
                    devicesLayer.clearLayers();
                    devices.forEach(d => {
                        if (d.floor_id === maps[currentMapIndex].id && d.map_coordinates) {
                            let glowClass = d.status === 'online' ? 'glow-green' : (d.status === 'amber' ? 'glow-amber' : 'glow-red');
                            let iconHTML = null;
                            if (d.type === 'printer') iconHTML = 'üñ®Ô∏è';
                            else if (d.type === 'telephone') iconHTML = 'üìû';
                            else if (d.type === 'wap') iconHTML = 'üì°'; 
                            else if (d.type === 'access_control') iconHTML = 'üîê';
                            else if (d.type === 'cctv') iconHTML = 'üìπ';
                            else if (d.type === 'nvr') iconHTML = 'üìº';

                            if (iconHTML) {
                                const icon = L.divIcon({ className: `custom-icon ${glowClass}`, html: iconHTML, iconSize: [25, 25], iconAnchor: [12, 12] });
                                L.marker([d.map_coordinates.y, d.map_coordinates.x], {icon: icon}).addTo(devicesLayer).bindTooltip(d.name || 'Device', {direction:'top'}).bindPopup(getPopupContent(d));
                            } else {
                                let color = d.status === 'online' ? '#00d26a' : (d.status === 'amber' ? '#ffc107' : '#f8312f');
                                L.circleMarker([d.map_coordinates.y, d.map_coordinates.x], { color: 'transparent', fillColor: color, fillOpacity: 0.9, radius: 8 }).addTo(devicesLayer).bindTooltip(d.name || 'Device', {permanent: false, direction: 'top'}).bindPopup(getPopupContent(d));
                            }
                        }
                    });
                }
            } catch(e) {}

            try {
                const sRes = await fetch('/api/status');
                const speed = await sRes.json();
                document.getElementById('net-ping').innerText = speed.ping || '--';
                const pVal = parseInt(speed.ping);
                const pElem = document.getElementById('net-ping');
                pElem.style.color = pVal < 50 ? '#00d26a' : (pVal < 100 ? '#ffc107' : '#f8312f');
            } catch (e) {}
        }

        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }, 1000);
        startMapTimer();
        loadMap(0); 
        updateDashboard(); 
        setInterval(updateDashboard, 5000); 
    </script>
</body>
</html>
