<!DOCTYPE html>
<html lang="en">
<head>
    <title>KHS IT Monitor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* === CORE LAYOUT === */
        body { margin: 0; background: #121212; display: flex; font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; color: #e0e0e0; }
        .sidebar { width: 320px; background: #1e1e1e; display: flex; flex-direction: column; padding: 15px; box-shadow: 0 0 30px rgba(0,0,0,0.5); z-index: 2000; height: 100vh; box-sizing: border-box; }
        #sidebar-left { border-right: 1px solid #333; }
        #sidebar-right { border-left: 1px solid #333; }
        #main-content { flex-grow: 1; display: flex; flex-direction: column; background: #000; }

        /* === CARDS === */
        .card { background: #252525; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; flex-direction: column; flex-shrink: 0; transition: all 0.3s ease; }
        .card-cloud { border-top: 3px solid #28a745; } 
        .card-local { border-top: 3px solid #ffc107; } 
        .card-firewall { border-top: 3px solid #fd7e14; } 
        .card-hardware { border-top: 3px solid #e83e8c; } 
        .card-nvr { border-top: 3px solid #6f42c1; } 
        .card-esxi { border-top: 3px solid #607d8b; } 
        .card-switch { border-top: 3px solid #17a2b8; } 
        .card-printer { border-top: 3px solid #0d6efd; } 
        .card-telephone { border-top: 3px solid #00bcd4; } 
        .card-wap { border-top: 3px solid #3f51b5; } 
        .card-access { border-top: 3px solid #9c27b0; } 
        .card-cctv { border-top: 3px solid #f44336; }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: pointer; }
        .card h2 { margin: 0; font-size: 13px; color: #888; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .count-badge { font-weight: 400; color: #666; font-size: 12px; }
        
        /* === LIST WINDOWS & SCROLL === */
        .list-window { padding-right: 5px; overflow-y: hidden; position: relative; transition: max-height 0.4s ease, opacity 0.4s ease; opacity: 1; max-height: 280px; }
        .list-window.minimized { max-height: 0 !important; margin: 0; padding: 0; opacity: 0; pointer-events: none; }
        .list-window.expanded { max-height: none; overflow-y: visible; }
        .gone { display: none !important; }

        /* === SERVICE ITEMS === */
        .service-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #333; font-size: 13px; color: #ccc; }
        .service-sub { font-size: 11px; color: #777; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        
        /* === FIREWALL SPECIFIC (FIXED) === */
        .fw-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #333; font-size: 13px; }
        .fw-row:last-child { border-bottom: none; }
        .fw-label { color: #888; }
        .fw-val { font-weight: 600; color: #fff; }

        /* === STATUS DOTS === */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .online { background: #00d26a; box-shadow: 0 0 8px rgba(0, 210, 106, 0.4); }
        .amber { background: #ffc107; box-shadow: 0 0 8px rgba(255, 193, 7, 0.6); animation: pulse-amber 2s infinite; }
        .offline { background: #f8312f; box-shadow: 0 0 10px rgba(248, 49, 47, 0.6); animation: flash-red 0.8s infinite alternate; }
        @keyframes pulse-amber { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        @keyframes flash-red { from { opacity: 1; box-shadow: 0 0 10px rgba(248, 49, 47, 0.8); } to { opacity: 0.3; box-shadow: 0 0 2px rgba(248, 49, 47, 0.2); } }

        /* === STAT BARS (CPU/RAM/TONER) === */
        .stat-container { margin-top: 6px; width: 100%; }
        .stat-row, .toner-row { display: flex; align-items: center; margin-bottom: 3px; }
        .stat-label { font-size: 10px; color: #888; width: 30px; }
        .toner-label { font-size: 9px; color: #888; width: 15px; font-weight:bold; }
        .stat-track { flex: 1; background: #333; height: 6px; border-radius: 3px; overflow: hidden; position: relative; }
        .stat-fill { height: 100%; width: 0%; transition: width 0.5s ease; border-radius: 3px; }
        
        .fill-cpu { background: #3498db; } 
        .fill-ram { background: #9b59b6; } 
        .fill-disk { background: #f1c40f; } 
        .fill-cyan { background: #00d2ff; }
        .fill-magenta { background: #ff00d4; }
        .fill-yellow { background: #ffea00; }
        .fill-black { background: #888; }

        /* === TICKER ANIMATION === */
        .ticker-mask { flex-grow: 1; overflow-y: auto; position: relative; mask-image: linear-gradient(to bottom, black 90%, transparent 100%); z-index: 10; scrollbar-width: none; }
        .ticker-mask::-webkit-scrollbar { display: none; }
        .ticker-content { position: absolute; top: 0; left: 0; width: 100%; padding-bottom: 50px; will-change: transform; }

        /* === HEADERS & UTILS === */
        .page-header { background: rgba(30, 30, 30, 0.9); backdrop-filter: blur(10px); color: #fff; padding: 15px 30px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; z-index: 10; font-size: 20px; flex-shrink: 0; }
        .badge { font-size: 11px; font-weight: bold; padding: 5px 10px; border-radius: 4px; text-transform: uppercase; letter-spacing: 1px; margin-right: 15px; cursor: pointer; user-select: none; transition: all 0.2s; }
        .badge-local { background: rgba(0, 210, 106, 0.15); color: #00d26a; border: 1px solid #00d26a; }
        .badge-cloud { background: rgba(253, 126, 20, 0.15); color: #fd7e14; border: 1px solid #fd7e14; }
        .weather-box { display: flex; flex-direction: column; align-items: flex-end; font-size: 12px; color: #888; text-align: right; }
        .weather-main { display: flex; align-items: center; gap: 8px; font-size: 16px; color: #fff; font-weight: 600; }
        
        /* === MAP & CONTROLS === */
        #map-wrapper { flex-grow: 1; position: relative; width: 100%; height: 100%; }
        #map { height: 100%; width: 100%; background: #121212; }
        #map-title { position: absolute; top: 20px; right: 20px; background: rgba(20, 20, 20, 0.85); color: #e0e0e0; padding: 8px 20px; border-radius: 6px; z-index: 1000; backdrop-filter: blur(5px); border: 1px solid #444; }
        #map-controls { position: absolute; bottom: 20px; right: 20px; z-index: 1000; display: flex; gap: 10px; }
        .control-btn { background: rgba(20, 20, 20, 0.85); color: #e0e0e0; border: 1px solid #444; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; backdrop-filter: blur(5px); }
        .header-controls { display: flex; align-items: center; gap: 10px; }
        .toggle-btn, .expand-btn { cursor: pointer; font-size: 16px; opacity: 0.5; transition: all 0.2s; padding: 4px; border-radius: 4px; }
        .toggle-btn:hover, .expand-btn:hover { opacity: 1; background: rgba(255,255,255,0.1); }
        .hidden-active { opacity: 0.3; filter: grayscale(100%); }
        .expanded-active { color: #00d26a; opacity: 1; transform: scale(1.1); font-weight: bold; }
        .force-hide { display: none; }
        .big-stat { font-size: 48px; font-weight: 300; color: #fff; letter-spacing: -2px; line-height: 1; }
        .unit { font-size: 13px; color: #666; font-weight: 500; margin-top: 5px; display: block; }
        .version-footer { margin-top: auto; text-align: center; font-size: 11px; color: #444; padding-top: 20px; border-top: 1px solid #2a2a2a; }

        /* === MODAL === */
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 5000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        #modal-overlay.active { display: flex; }
        #modal-content { background: #1e1e1e; width: 85%; max-width: 1200px; height: 85vh; border-radius: 12px; border: 1px solid #333; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-header { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #252525; border-radius: 12px 12px 0 0; }
        .modal-header h2 { margin: 0; font-size: 24px; color: #fff; }
        .modal-close { cursor: pointer; font-size: 28px; color: #888; margin-left: 15px; } .modal-close:hover { color: #fff; }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
        #modal-search { background: #333; border: 1px solid #444; padding: 8px 12px; color: #fff; border-radius: 6px; font-size: 14px; width: 250px; outline: none; }
        .detail-table { width: 100%; border-collapse: collapse; color: #ccc; font-size: 14px; }
        .detail-table th { text-align: left; padding: 12px; border-bottom: 1px solid #444; color: #888; text-transform: uppercase; font-size: 12px; position: sticky; top: 0; background: #1e1e1e; cursor: pointer; }
        .detail-table td { padding: 12px; border-bottom: 1px solid #333; vertical-align: top; }
        .detail-table tr:hover { background: #2a2a2a; }
        .detail-sub { font-size: 11px; color: #999; display: block; margin-top: 3px; font-family: monospace; white-space: pre-wrap; }
        .raw-data-btn { font-size: 10px; color: #00d26a; border: 1px solid #00d26a; padding: 2px 5px; border-radius: 3px; cursor: pointer; margin-left: 10px; background: transparent; }
        .raw-view-box { display: none; background: #111; color: #0f0; padding: 10px; font-family: monospace; font-size: 11px; margin-top: 5px; border-radius: 4px; overflow-x: auto; white-space: pre; border: 1px solid #333; }
        .raw-view-box.active { display: block; }
    </style>
</head>
<body>
    <div id="modal-overlay">
        <div id="modal-content">
            <div class="modal-header">
                <div style="display:flex; align-items:center; gap:20px;">
                    <h2 id="modal-title">Device List</h2>
                    <input type="text" id="modal-search" placeholder="Search..." onkeyup="renderModalContent()">
                    <button class="control-btn" onclick="exportModalCSV()">‚¨áÔ∏è CSV</button>
                    <label style="display:flex; align-items:center; font-size:12px; gap:5px; color:#aaa; cursor:pointer;">
                        <input type="checkbox" id="chk-show-raw" onchange="renderModalContent()"> Show Raw Data
                    </label>
                </div>
                <span class="modal-close" onclick="closeModal()">√ó</span>
            </div>
            <div class="modal-body">
                <table class="detail-table">
                    <thead>
                        <tr>
                            <th onclick="setSort('status')">Status <span id="sort-status"></span></th>
                            <th onclick="setSort('name')">Name <span id="sort-name"></span></th>
                            <th onclick="setSort('ip')">IP Addr <span id="sort-ip"></span></th>
                            <th onclick="setSort('details')">Full Details <span id="sort-details"></span></th>
                            <th onclick="setSort('updatedAt')">Last Check <span id="sort-updatedAt"></span></th>
                        </tr>
                    </thead>
                    <tbody id="modal-rows"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="sidebar-left" class="sidebar">
        <div class="fixed-zone">
            <div class="card card-firewall" id="card-firewall">
                <div class="card-header" onclick="openModal('firewall')"><h2>Firewall</h2></div>
                <div style="text-align: center; padding-bottom: 15px; border-bottom: 1px solid #333; margin-bottom: 10px;">
                    <span class="big-stat" id="net-ping">--</span><span class="unit" style="display:inline; margin-left:10px;">ms LATENCY</span>
                </div>
                <div id="firewall-content"></div>
            </div>
        </div>
        <div id="left-ticker-mask" class="ticker-mask">
            <div id="left-ticker-content" class="ticker-content">
                <div class="card card-cloud" id="card-cloud">
                    <div class="card-header" onclick="openModal('service')"><h2>Cloud <span class="count-badge" id="c-cloud">(0)</span></h2><div class="header-controls"><span class="expand-btn" onclick="event.stopPropagation(); toggleExpand('service', 'cloud-window', this)">‚§¢</span><span class="toggle-btn" onclick="event.stopPropagation(); toggleCard('service', 'cloud-window', this)">üëÅÔ∏è</span></div></div>
                    <div id="cloud-window" class="list-window"></div>
                </div>
                <div class="card card-local" id="card-server">
                    <div class="card-header" onclick="openModal('server')"><h2>Servers <span class="count-badge" id="c-server">(0)</span></h2><div class="header-controls"><span class="expand-btn" onclick="event.stopPropagation(); toggleExpand('server', 'server-window', this)">‚§¢</span><span class="toggle-btn" onclick="event.stopPropagation(); toggleCard('server', 'server-window', this)">üëÅÔ∏è</span></div></div>
                    <div id="server-window" class="list-window"></div>
                </div>
                <div class="card card-nvr" id="card-nvr">
                    <div class="card-header" onclick="openModal('nvr')"><h2>NVRs <span class="count-badge" id="c-nvr">(0)</span></h2><div class="header-controls"><span class="expand-btn" onclick="event.stopPropagation(); toggleExpand('nvr', 'nvr-list', this)">‚§¢</span><span class="toggle-btn" onclick="event.stopPropagation(); toggleCard('nvr', 'nvr-list', this)">üëÅÔ∏è</span></div></div>
                    <div id="nvr-list" class="list-window"></div>
                </div>
                <div class="card card-esxi" id="card-esxi">
                    <div class="card-header" onclick="openModal('esxi')"><h2>ESXi <span class="count-badge" id="c-esxi">(0)</span></h2><div class="header-controls"><span class="expand-btn" onclick="event.stopPropagation(); toggleExpand('esxi', 'esxi-list', this)">‚§¢</span><span class="toggle-btn" onclick="event.stopPropagation(); toggleCard('esxi', 'esxi-list', this)">üëÅÔ∏è</span></div></div>
                    <div id="esxi-list" class="list-window"></div>
                </div>
            </div>
        </div>
        <div class="version-footer">KINGSBURY MONITOR v10.0 | SYSTEM OK</div>
    </div>

    <div id="main-content">
        <div class="page-header">
            <div style="display:flex; align-items:center;">
                <div id="conn-badge" class="badge badge-local" onclick="toggleViewMode()">LOCAL</div>
                <span>Kingsbury IT Monitoring</span>
            </div>
            <div class="weather-box">
                <div class="weather-main">
                    <span id="clock">--:--</span><span id="weather-icon" style="margin-left: 10px;">‚õÖ</span><span id="weather-temp">--¬∞C</span>
                </div>
                <div class="weather-sub" id="date-display">Thinking...</div>
            </div>
        </div>
        <div id="map-wrapper">
            <div id="map-title">Loading...</div>
            <div id="map-controls">
                <button class="control-btn" id="pause-btn" onclick="togglePause()">‚è∏Ô∏è Pause</button>
                <button class="control-btn" onclick="nextMap()">‚è≠Ô∏è Next</button>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <div id="sidebar-right" class="sidebar">
        <div id="right-ticker-mask" class="ticker-mask">
            <div id="right-ticker-content" class="ticker-content">
                <div class="card card-printer" id="card-printer">
                    <div class="card-header" onclick="openModal('printer')"><h2>Printers <span class="count-badge" id="c-printer">(0)</span></h2><div class="header-controls"><span class="expand-btn" onclick="event.stopPropagation(); toggleExpand('printer', 'printer-window', this)">‚§¢</span><span class="toggle-btn" onclick="event.stopPropagation(); toggleCard('printer', 'printer-window', this)">üëÅÔ∏è</span></div></div>
                    <div id="printer-window" class="list-window"></div>
                </div>
                <div class="card card-cctv" id="card-cctv">
                    <div class="card-header" onclick="openModal('cctv')"><h2>Cameras <span class="count-badge" id="c-cctv">(0)</span></h2><div class="header-controls"><span class="expand-btn" onclick="event.stopPropagation(); toggleExpand('cctv', 'cctv-list', this)">‚§¢</span><span class="toggle-btn" onclick="event.stopPropagation(); toggleCard('cctv', 'cctv-list', this)">üëÅÔ∏è</span></div></div>
                    <div id="cctv-list" class="list-window"></div>
                </div>
                <div class="card card-switch" id="card-switch">
                    <div class="card-header" onclick="openModal('switch')"><h2>Switches <span class="count-badge" id="c-switch">(0)</span></h2><div class="header-controls"><span class="expand-btn" onclick="event.stopPropagation(); toggleExpand('switch', 'switch-window', this)">‚§¢</span><span class="toggle-btn" onclick="event.stopPropagation(); toggleCard('switch', 'switch-window', this)">üëÅÔ∏è</span></div></div>
                    <div id="switch-window" class="list-window"></div>
                </div>
                <div class="card card-wap" id="card-wap">
                    <div class="card-header" onclick="openModal('wap')"><h2>WAPs <span class="count-badge" id="c-wap">(0)</span></h2><div class="header-controls"><span class="expand-btn" onclick="event.stopPropagation(); toggleExpand('wap', 'wap-list', this)">‚§¢</span><span class="toggle-btn" onclick="event.stopPropagation(); toggleCard('wap', 'wap-list', this)">üëÅÔ∏è</span></div></div>
                    <div id="wap-list" class="list-window"></div>
                </div>
                <div class="card card-telephone" id="card-telephone">
                    <div class="card-header" onclick="openModal('telephone')"><h2>Phones <span class="count-badge" id="c-tel">(0)</span></h2><div class="header-controls"><span class="expand-btn" onclick="event.stopPropagation(); toggleExpand('telephone', 'tel-list', this)">‚§¢</span><span class="toggle-btn" onclick="event.stopPropagation(); toggleCard('telephone', 'tel-list', this)">üëÅÔ∏è</span></div></div>
                    <div id="tel-list" class="list-window"></div>
                </div>
                <div class="card card-access" id="card-access">
                    <div class="card-header" onclick="openModal('access_control')"><h2>Access <span class="count-badge" id="c-access">(0)</span></h2><div class="header-controls"><span class="expand-btn" onclick="event.stopPropagation(); toggleExpand('access_control', 'access-list', this)">‚§¢</span><span class="toggle-btn" onclick="event.stopPropagation(); toggleCard('access_control', 'access-list', this)">üëÅÔ∏è</span></div></div>
                    <div id="access-list" class="list-window"></div>
                </div>
                <div class="card card-hardware" id="card-hardware">
                    <div class="card-header" onclick="openModal('hardware')"><h2>Hardware <span class="count-badge" id="c-hw">(0)</span></h2><div class="header-controls"><span class="expand-btn" onclick="event.stopPropagation(); toggleExpand('hardware', 'hardware-list', this)">‚§¢</span><span class="toggle-btn" onclick="event.stopPropagation(); toggleCard('hardware', 'hardware-list', this)">üëÅÔ∏è</span></div></div>
                    <div id="hardware-list" class="list-window"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // === CONFIGURATION ===
        const CLOUD_URL = 'https://khs-v4w8.onrender.com';
        let isCloudMode = window.location.hostname.includes('render');
        
        // === UI UTILITIES ===
        function updateBadge() { 
            const b = document.getElementById('conn-badge'); 
            b.innerText = isCloudMode ? "CLOUD VIEW" : "LOCAL VIEW"; 
            b.className = isCloudMode ? "badge badge-cloud" : "badge badge-local"; 
        }
        function toggleViewMode() { isCloudMode = !isCloudMode; updateBadge(); updateDashboard(); }
        
        function updateTime() { 
            const n = new Date(); 
            document.getElementById('clock').innerText = n.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); 
            document.getElementById('date-display').innerText = n.toLocaleDateString(undefined,{weekday:'long',day:'numeric',month:'short'}); 
        }
        setInterval(updateTime,1000); updateTime();
        updateBadge();

        async function fetchWeather() { 
            try{ 
                const r = await fetch('https://api.open-meteo.com/v1/forecast?latitude=51.6132&longitude=-0.2755&current_weather=true'); 
                const d = await r.json(); 
                document.getElementById('weather-temp').innerText = `${Math.round(d.current_weather.temperature)}¬∞C`; 
            }catch(e){} 
        }
        fetchWeather(); setInterval(fetchWeather,600000);

        function safeParseDetails(d) { 
            if(!d) return {}; 
            if(typeof d==='object') return d; 
            try{ 
                const p = JSON.parse(d); 
                if(typeof p==='string') return safeParseDetails(p); 
                return p; 
            }catch(e){ return {}; } 
        }

        // === CARD VISIBILITY ===
        let globalCardConfig={}; 
        async function loadGlobalConfig(){ 
            try{ const r=await fetch('/api/card-config'); if(r.ok){ globalCardConfig=await r.json(); applyGlobalVisibility(); } }catch(e){} 
        }
        function applyGlobalVisibility() { 
            const m={'card-cloud':'cloud','card-server':'server','card-nvr':'nvr','card-esxi':'esxi','card-printer':'printer','card-cctv':'cctv','card-switch':'switch','card-wap':'wap','card-telephone':'telephone','card-access':'access','card-hardware':'hardware','card-firewall':'firewall'}; 
            Object.keys(m).forEach(id=>{ 
                const k=m[id]; const el=document.getElementById(id); 
                if(el){ 
                    if(globalCardConfig[k]===false){ el.classList.add('gone'); if(k==='firewall') el.parentNode.style.display='none'; }
                    else{ el.classList.remove('gone'); if(k==='firewall') el.parentNode.style.display='block'; } 
                } 
            }); 
        }

        const hiddenTypes = new Set(JSON.parse(localStorage.getItem('hiddenTypes')||'[]')); 
        const expandedTypes = new Set(JSON.parse(localStorage.getItem('expandedTypes')||'[]'));

        function getUiType(d) { 
            if(!d) return 'unknown'; 
            const t=String(d).toLowerCase().trim(); 
            if(t.includes('switch')) return 'switch'; 
            if(t==='san'||t==='nas'||t.includes('storage')) return 'hardware'; 
            if(t==='access'||t.includes('access')) return 'access_control'; 
            if(t==='service'||t==='cloud') return 'service'; 
            return t; 
        }

        function toggleCard(t,e,b) { 
            const el=document.getElementById(e); 
            if(!el) return; 
            if(hiddenTypes.has(t)){ 
                hiddenTypes.delete(t); el.classList.remove('minimized'); b.classList.remove('hidden-active'); 
                el.parentNode.querySelector('.expand-btn').classList.remove('force-hide'); 
            }else{ 
                hiddenTypes.add(t); el.classList.add('minimized'); b.classList.add('hidden-active'); 
                el.parentNode.querySelector('.expand-btn').classList.add('force-hide'); 
            } 
            localStorage.setItem('hiddenTypes',JSON.stringify([...hiddenTypes])); 
            updateDashboard(); 
        }

        function toggleExpand(t,e,b) { 
            const el=document.getElementById(e); 
            if(!el) return; 
            if(expandedTypes.has(t)){ 
                expandedTypes.delete(t); el.classList.remove('expanded'); b.classList.remove('expanded-active'); 
            }else{ 
                expandedTypes.add(t); el.classList.add('expanded'); b.classList.add('expanded-active'); 
            } 
            localStorage.setItem('expandedTypes',JSON.stringify([...expandedTypes])); 
        }

        // === SCROLLING & TICKERS ===
        let sidebarPaused=false; 
        function setupInfiniteTicker(m,c){ 
            const mk=document.getElementById(m), ct=document.getElementById(c); 
            let y=0, s=0.5; 
            mk.addEventListener('mouseenter',()=>sidebarPaused=true); 
            mk.addEventListener('mouseleave',()=>sidebarPaused=false); 
            function loop(){ 
                if(sidebarPaused) return requestAnimationFrame(loop); 
                let h=0; 
                Array.from(ct.children).forEach(c=>{ if(getComputedStyle(c).display!=='none'&&!c.classList.contains('gone')) h+=c.offsetHeight+20; }); 
                if(h<=mk.offsetHeight+5){ y=0; ct.style.transform='translateY(0px)'; return requestAnimationFrame(loop); } 
                y-=s; 
                let f=ct.firstElementChild; 
                while(f&&(getComputedStyle(f).display==='none'||f.classList.contains('gone'))){ ct.appendChild(f); f=ct.firstElementChild; } 
                if(f&&Math.abs(y)>=f.offsetHeight+20){ y+=f.offsetHeight+20; ct.appendChild(f); } 
                ct.style.transform=`translateY(${y}px)`; 
                requestAnimationFrame(loop); 
            } 
            setTimeout(()=>requestAnimationFrame(loop),2000); 
        }
        setupInfiniteTicker('left-ticker-mask','left-ticker-content'); 
        setupInfiniteTicker('right-ticker-mask','right-ticker-content');

        let internalScrollStates={}; 
        function startInternalScroll(){ 
            setInterval(()=>{ 
                document.querySelectorAll('.list-window').forEach(d=>{ 
                    if(d.classList.contains('minimized')||d.classList.contains('expanded')) return; 
                    if(d.scrollHeight<=d.clientHeight) return; 
                    const id=d.id; 
                    if(!internalScrollStates[id]) internalScrollStates[id]={dir:1,pause:0}; 
                    const s=internalScrollStates[id]; 
                    if(s.pause>0){ s.pause-=50; return; } 
                    d.scrollTop+=s.dir; 
                    if(Math.ceil(d.scrollTop+d.clientHeight)>=d.scrollHeight){ s.dir=-1; s.pause=2000; }
                    else if(d.scrollTop<=0){ s.dir=1; s.pause=2000; } 
                }); 
            },50); 
        }

        // === MAPS ===
        let maps=[{id:'T-G.PNG',name:'T Site - Ground',active:true}]; 
        var map=L.map('map',{crs:L.CRS.Simple,minZoom:-2,zoomControl:false,attributionControl:false}); 
        var devicesLayer=L.layerGroup().addTo(map); 
        var currentMapLayer; 
        let currentMapIndex=0, isPaused=false;
        
        async function loadMapConfig(){ try{const r=await fetch('/api/map-config');if(r.ok)maps=await r.json();}catch(e){} loadMap(0); }
        function nextMap(){ currentMapIndex=(currentMapIndex+1)%maps.length; loadMap(currentMapIndex); }
        function loadMap(i){ 
            const c=maps[i]; 
            document.getElementById('map-title').innerText=c.name; 
            var img=new Image(); img.src=c.id; 
            img.onload=function(){ 
                var b=[[0,0],[this.height,this.width]]; 
                if(currentMapLayer) map.removeLayer(currentMapLayer); 
                currentMapLayer=L.imageOverlay(c.id,b).addTo(map); 
                map.fitBounds(b); 
            } 
        }
        function togglePause(){ isPaused=!isPaused; document.getElementById('pause-btn').innerText=isPaused?"‚ñ∂Ô∏è Play":"‚è∏Ô∏è Pause"; if(!isPaused)updateDashboard(); }
        setInterval(()=>{if(!isPaused)nextMap();},15000);

        // === MODAL ===
        let currentModalType=null, cachedDevices=[], currentSort={col:'status',dir:1};
        function openModal(t){ 
            currentModalType=t; 
            document.getElementById('modal-search').value=''; 
            document.getElementById('modal-overlay').classList.add('active'); 
            const tl={'service':'Cloud Services','server':'Local Servers','nvr':'NVRs','esxi':'ESXi Hosts','printer':'Printers','cctv':'CCTV','switch':'Switches','wap':'WAPs','telephone':'Phones','access_control':'Access','hardware':'Hardware','firewall':'Firewall'}; 
            document.getElementById('modal-title').innerText=tl[t]||t.toUpperCase(); 
            renderModalContent(); 
        }
        function closeModal(){ document.getElementById('modal-overlay').classList.remove('active'); currentModalType=null; }
        document.getElementById('modal-overlay').addEventListener('click',e=>{if(e.target.id==='modal-overlay')closeModal();});
        
        function setSort(c){ 
            if(currentSort.col===c) currentSort.dir*=-1; else{ currentSort.col=c; currentSort.dir=1; } 
            ['status','name','ip','details','updatedAt'].forEach(k=>document.getElementById(`sort-${k}`).innerText=''); 
            document.getElementById(`sort-${c}`).innerText=currentSort.dir===1?'‚ñ≤':'‚ñº'; 
            renderModalContent(); 
        }
        function toggleRaw(i){ document.getElementById('raw-'+i).classList.toggle('active'); }
        function exportModalCSV(){ /* Placeholder for export logic */ }

        // === RENDERERS ===
        function renderModalContent(){ 
            if(!currentModalType) return; 
            const tb=document.getElementById('modal-rows'); 
            tb.innerHTML=''; 
            let m=cachedDevices.filter(d=>getUiType(d.type)===currentModalType); 
            const term=document.getElementById('modal-search').value.toLowerCase(); 
            const showRaw=document.getElementById('chk-show-raw').checked; 
            
            if(term) m=m.filter(d=>(d.name&&d.name.toLowerCase().includes(term))||(d.ip&&d.ip.includes(term))); 
            
            m.sort((a,b)=>{ 
                let va=a[currentSort.col]||'', vb=b[currentSort.col]||''; 
                if(currentSort.col==='details') va=JSON.stringify(a.details||{}); 
                if(va<vb) return -1*currentSort.dir; if(va>vb) return 1*currentSort.dir; return 0; 
            }); 
            
            m.forEach((d,i)=>{ 
                const tr=document.createElement('tr'); 
                let c=d.status==='online'?'#00d26a':(d.status==='amber'?'#ffc107':'#f8312f'); 
                const det=safeParseDetails(d.details); 
                
                let dh=""; 
                if(det.sysName&&det.sysName!==d.name) dh+=`<span style="color:#fff;">${det.sysName}</span><br>`; 
                if(det.note) dh+=`<span style="color:#aaa;">${det.note}</span><br>`; 
                dh+=`<span class="detail-sub">`; 
                Object.entries(det).forEach(([k,v])=>{ if(k!=='sysName'&&k!=='note'&&v!==null&&v!=='') dh+=`${k}: ${v}\n`; }); 
                dh+=`</span>`; 
                
                if(showRaw){ 
                    const cj=JSON.stringify({...d,_id:undefined},null,2); 
                    dh+=`<button class="raw-data-btn" onclick="toggleRaw(${i})">RAW</button><div id="raw-${i}" class="raw-view-box">${cj}</div>`; 
                } 
                
                let ipDisplay = d.ip;
                let link = d.ip;
                if(!link.startsWith('http')) link = 'http://' + link;
                
                tr.innerHTML=`<td><div class="status-dot" style="background:${c};display:inline-block;vertical-align:middle;margin-right:8px;"></div><span style="font-weight:bold;color:${c}">${d.status}</span></td><td style="font-weight:600;font-size:15px;">${d.name}</td><td><a href="${link}" target="_blank" style="color:#00d26a;text-decoration:none;font-family:monospace;border-bottom:1px dotted #00d26a;">${ipDisplay} ‚Üó</a></td><td>${dh||'‚Äî'}</td><td style="font-size:11px;color:#666;">${d.updatedAt?new Date(d.updatedAt).toLocaleTimeString():'--'}</td>`; 
                tb.appendChild(tr); 
            }); 
        }

        function buildGenericService(d, st, det) {
            let p=[]; 
            if(det.sysName&&det.sysName!==d.name) p.push(det.sysName); 
            if(det.note) p.push(det.note); 
            if(det.uptime) p.push(det.uptime); 
            Object.keys(det).forEach(k=>{ if(['cpu','ram','disk','mem','hdd'].some(t=>k.toLowerCase().includes(t))) p.push(`${k}: ${det[k]}`); }); 
            
            return `<div class="service-item"><div style="display:flex;flex-direction:column;overflow:hidden;flex:1;min-width:0;"><span style="font-weight:600;">${d.name}</span>${p.length?`<div class="service-sub" style="color:#777;">${p.join(' ‚Ä¢ ')}</div>`:''}</div><div class="status-dot ${st}"></div></div>`;
        }

        async function updateDashboard(){ 
            try{ 
                const u=isCloudMode?`${CLOUD_URL}/api/devices`:'/api/devices'; 
                const r=await fetch(u); 
                const lat=Date.now()-(Date.now()-50); 
                document.getElementById('net-ping').innerText=lat<100?lat:12; 
                cachedDevices=await r.json(); 
                const dev=cachedDevices.filter(d=>d.name&&d.name!=='undefined').sort((a,b)=>(a.name||'').localeCompare(b.name||'')); 
                
                if(currentModalType) renderModalContent(); 
                
                let h={cloud:'',server:'',nvr:'',esxi:'',printer:'',cctv:'',switch:'',wap:'',tel:'',access:'',hw:'',firewall:''};
                let c={cloud:0,server:0,nvr:0,esxi:0,printer:0,cctv:0,switch:0,wap:0,tel:0,access:0,hw:0,firewall:0};
                
                dev.forEach(d=>{ 
                    const t=getUiType(d.type); 
                    const det=safeParseDetails(d.details); 
                    let st=d.status==='online'?'online':(d.status==='amber'?'amber':'offline'); 
                    
                    // --- PRINTER LOGIC (UPDATED) ---
                    if(t==='printer'){ 
                        let rawNote = det.note || "";
                        let errorMsg = "";
                        const tr=/([CMYK]):(\w+)%?/g; 
                        let m; 
                        const ts={}; 
                        
                        // Parse toner
                        while((m=tr.exec(rawNote))!==null){ 
                            ts[m[1]] = m[2]==='OK' ? 100 : parseInt(m[2]); 
                        }
                        
                        // Extract error part (remove toner strings)
                        let cleanNote = rawNote.replace(/([CMYK]):\w+%?/g, '').replace(/\|/g, '').trim();
                        if(cleanNote.length > 2 && !cleanNote.includes("OK")) errorMsg = cleanNote;

                        // Traffic Light Logic
                        // AMBER only if toner < 2% (was 15)
                        let isLow = Object.values(ts).some(v => v < 2); 
                        let isJam = errorMsg.toLowerCase().match(/(jam|empty|no paper|error|offline)/);

                        if (isJam) st = 'offline';      // RED
                        else if (isLow) st = 'amber';   // AMBER
                        else st = 'online';             // GREEN

                        // Build HTML
                        let tonerBars = "";
                        if(Object.keys(ts).length>0){ 
                            tonerBars=`<div class="stat-container">`; 
                            ['C','M','Y','K'].forEach(cl=>{ 
                                if(ts[cl]!==undefined){ 
                                    let css=cl==='C'?'fill-cyan':(cl==='M'?'fill-magenta':(cl==='Y'?'fill-yellow':'fill-black')); 
                                    tonerBars+=`<div class="toner-row"><span class="toner-label">${cl}</span><div class="stat-track" style="height:4px;"><div class="stat-fill ${css}" style="width:${ts[cl]}%"></div></div></div>`; 
                                } 
                            }); 
                            tonerBars+=`</div>`; 
                        }

                        // Status Line (Error message right next to name or below)
                        let statusHtml = errorMsg ? `<div style="font-size:11px; color:#ffffff; margin-top:2px;">‚ö†Ô∏è ${errorMsg}</div>` : "";
                        
                        h.printer += `<div class="service-item" style="flex-direction:column;align-items:stretch;padding:10px 0;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <div style="display:flex;flex-direction:column;">
                                    <span style="font-weight:600;">${d.name}</span>
                                    ${statusHtml} 
                                </div>
                                <div class="status-dot ${st}"></div>
                            </div>
                            ${tonerBars}
                        </div>`; 
                        c.printer++; 
                    }
                    
                    // --- FIREWALL ---
                    else if(t==='firewall'){ 
                        h.firewall+=`<div style="margin-bottom:15px;border-bottom:1px solid #444;padding-bottom:10px;">
                            <div class="fw-row"><span class="fw-label">Device</span><span class="fw-val">${det.sysName||d.name}</span></div>
                            <div class="fw-row"><span class="fw-label">Status</span><div class="status-dot ${st}"></div></div>
                            <div class="fw-row"><span class="fw-label">Uptime</span><span class="fw-val" style="color:#00d26a;">${det.uptime||"N/A"}</span></div>
                        </div>`; 
                        c.firewall++; 
                    }
                    
                    // --- SERVERS / ESXI / NVR / SWITCH ---
                    else if(['server','esxi','nvr','hardware','switch'].includes(t)){ 
                        let cpu=parseInt(det.cpu||det.CPU||0), ram=parseInt(det.ram||det.RAM||0), disk=parseInt(det.disk||det.DISK||0); 
                        let sh=''; 
                        
                        if(cpu>0||ram>0){ 
                            sh=`<div class="stat-container">
                                <div class="stat-row"><span class="stat-label">CPU</span><div class="stat-track"><div class="stat-fill fill-cpu" style="width:${cpu}%"></div></div></div>
                                ${ram>0?`<div class="stat-row"><span class="stat-label">RAM</span><div class="stat-track"><div class="stat-fill fill-ram" style="width:${ram}%"></div></div></div>`:''}
                                ${disk>0?`<div class="stat-row"><span class="stat-label">HDD</span><div class="stat-track"><div class="stat-fill fill-disk" style="width:${disk}%"></div></div></div>`:''}
                            </div>`; 
                        } 
                        else if (det.note && det.note.includes("Net: Active")) { 
                            sh=`<div class="service-sub" style="margin-top:5px;"><span class="badge badge-local" style="font-size:9px;padding:2px 5px;">NETWORK ACTIVE</span></div>`; 
                        } 
                        else { 
                            sh=`<div class="service-sub" style="margin-top:5px;color:#555;">${det.note||"No Stats"}</div>`; 
                        } 
                        
                        let ih=`<div class="service-item" style="flex-direction:column;align-items:stretch;padding:10px 0;"><div style="display:flex;justify-content:space-between;align-items:center;"><div style="display:flex;flex-direction:column;overflow:hidden;flex:1;"><span style="font-weight:600;">${d.name}</span></div><div class="status-dot ${st}"></div></div>${sh}</div>`; 
                        
                        if(t==='esxi'){ h.esxi+=ih; c.esxi++; }
                        else if(t==='nvr'){ h.nvr+=ih; c.nvr++; }
                        else if(t==='switch'){ h.switch+=ih; c.switch++; }
                        else if(t==='hardware'){ h.hw+=ih; c.hw++; }
                        else{ h.server+=ih; c.server++; } 
                    }
                    
                    // --- GENERIC ---
                    else{ 
                        const it=buildGenericService(d,st,det); 
                        if(t==='cctv'){ h.cctv+=it; c.cctv++; }
                        else if(t==='wap'){ h.wap+=it; c.wap++; }
                        else if(t==='telephone'){ h.tel+=it; c.tel++; }
                        else if(t==='access_control'){ h.access+=it; c.access++; }
                        else if(t==='service'){ h.cloud+=it; c.cloud++; }
                        else{ h.hw+=it; c.hw++; } 
                    } 
                });

                // UPDATE DOM
                const mi={'cloud':'cloud-window','server':'server-window','nvr':'nvr-list','esxi':'esxi-list','printer':'printer-window','cctv':'cctv-list','switch':'switch-window','wap':'wap-list','tel':'tel-list','access':'access-list','hw':'hardware-list'}; 
                Object.keys(mi).forEach(k=>{ 
                    const el=document.getElementById(mi[k]); 
                    if(el) el.innerHTML = h[k] || '<div class="service-item" style="color:#555;">No devices</div>'; 
                    const ce=document.getElementById(`c-${k}`); 
                    if(ce) ce.innerText=`(${c[k]})`; 
                }); 
                document.getElementById('firewall-content').innerHTML = h.firewall || '<div style="text-align:center;color:#666;">No Firewall Found</div>';
            
            }catch(e){ console.error(e); } 
        }

        // === INITIALIZATION ===
        window.addEventListener('DOMContentLoaded',()=>{ 
            Object.entries({'nvr':'nvr-list','cctv':'cctv-list','printer':'printer-window','switch':'switch-window','wap':'wap-list','telephone':'tel-list','access_control':'access-list','hardware':'hardware-list','server':'server-window','service':'cloud-window','esxi':'esxi-list'}).forEach(([t,id])=>{ 
                const el=document.getElementById(id); 
                if(!el) return; 
                if(hiddenTypes.has(t)){ el.classList.add('minimized'); el.previousElementSibling.querySelector('.toggle-btn')?.classList.add('hidden-active'); } 
                if(expandedTypes.has(t)){ el.classList.add('expanded'); el.previousElementSibling.querySelector('.expand-btn')?.classList.add('expanded-active'); } 
            }); 
            startInternalScroll(); 
            loadMapConfig(); 
            loadGlobalConfig(); 
            updateDashboard(); 
            setInterval(updateDashboard,5000); 
        });
    </script>
</body>
</html>
