<!DOCTYPE html>
<html>
<head>
    <title>KHS IT School Monitor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #121212; display: flex; font-family: 'Inter', 'Segoe UI', sans-serif; overflow: hidden; height: 100vh; color: #e0e0e0; }
        
        .sidebar { width: 320px; background: #1e1e1e; display: flex; flex-direction: column; padding: 25px; box-shadow: 0 0 30px rgba(0,0,0,0.5); z-index: 2000; }
        #sidebar-left { border-right: 1px solid #333; }
        #sidebar-right { border-left: 1px solid #333; }
        
        /* CARDS */
        .card { background: #252525; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        
        .card-speed { border-top: 3px solid #4db8ff; }
        .card-cloud { border-top: 3px solid #28a745; height: 150px; }
        .card-local { border-top: 3px solid #ffc107; flex-grow: 1; }
        
        /* New Firewall Card Style (Taller for details) */
        .card-firewall { border-top: 3px solid #fd7e14; min-height: 160px; }
        
        .card-hardware { border-top: 3px solid #e83e8c; height: auto; min-height: 0; } 
        .card-nvr { border-top: 3px solid #6f42c1; height: auto; min-height: 0; }      
        .card-switch { border-top: 3px solid #17a2b8; flex: 1; }         
        .card-printer { border-top: 3px solid #0d6efd; flex: 1; }        

        .card h2 { margin: 0 0 10px 0; font-size: 13px; color: #888; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; }
        .big-stat { font-size: 56px; font-weight: 300; color: #fff; letter-spacing: -2px; line-height: 1; }
        .unit { font-size: 13px; color: #666; font-weight: 500; margin-top: 5px; display: block; }
        
        /* LISTS */
        .list-window { overflow: hidden; position: relative; background: #252525; flex-grow: 1; }
        .static-list { width: 100%; }
        .list-content { position: absolute; width: 100%; top: 0; left: 0; }
        .service-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #333; font-size: 13px; color: #ccc; }
        
        /* STATUS LIGHTS */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .online { background: #00d26a; box-shadow: 0 0 8px rgba(0, 210, 106, 0.4); }
        .amber { background: #ffc107; box-shadow: 0 0 8px rgba(255, 193, 7, 0.6); animation: pulse-amber 2s infinite; }
        .offline { background: #f8312f; box-shadow: 0 0 10px rgba(248, 49, 47, 0.6); animation: flash-red 0.8s infinite alternate; }
        
        /* FIREWALL DATA STYLING */
        .fw-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; border-bottom: 1px solid #333; padding-bottom: 4px; }
        .fw-label { color: #888; }
        .fw-val { color: #fff; font-weight: 600; text-align: right; }
        .fw-desc { font-size: 11px; color: #666; line-height: 1.4; margin-top: 5px; max-height: 40px; overflow: hidden; }

        @keyframes pulse-amber { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        @keyframes flash-red { from { opacity: 1; box-shadow: 0 0 10px rgba(248, 49, 47, 0.8); } to { opacity: 0.3; box-shadow: 0 0 2px rgba(248, 49, 47, 0.2); } }

        #main-content { flex-grow: 1; display: flex; flex-direction: column; background: #000; }
        .page-header { background: rgba(30, 30, 30, 0.9); backdrop-filter: blur(10px); color: #fff; padding: 15px 30px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; z-index: 10; font-size: 20px; }
        #map-wrapper { flex-grow: 1; position: relative; width: 100%; height: 100%; }
        #map { height: 100%; width: 100%; background: #121212; }
        #map-title { position: absolute; top: 20px; right: 20px; background: rgba(20, 20, 20, 0.85); color: #e0e0e0; padding: 8px 20px; border-radius: 6px; z-index: 1000; backdrop-filter: blur(5px); border: 1px solid #444; }
        .version-footer { margin-top: auto; text-align: center; font-size: 11px; color: #444; padding-top: 20px; border-top: 1px solid #2a2a2a; }
    </style>
</head>
<body>

    <div id="sidebar-left" class="sidebar">
        <div class="card card-speed">
            <h2>Internet Bandwidth</h2>
            <div style="text-align: center; padding: 15px 0;">
                <div class="big-stat" id="down-speed">--</div>
                <span class="unit">Mbps DOWNLOAD</span>
            </div>
        </div>
        <div class="card card-cloud">
            <h2>Cloud Services</h2>
            <div id="cloud-window" class="list-window"><div id="cloud-content" class="list-content"></div></div>
        </div>
        <div class="card card-local">
            <h2>Local Servers</h2>
            <div id="server-window" class="list-window"><div id="server-content" class="list-content"></div></div>
        </div>
        <div class="version-footer">SYSTEM VERSION 2.1.0</div>
    </div>

    <div id="main-content">
        <div class="page-header"><span>Kingsbury IT Monitoring</span><span id="clock" style="font-size:14px; color:#888;"></span></div>
        <div id="map-wrapper"><div id="map-title">Loading...</div><div id="map"></div></div>
    </div>

    <div id="sidebar-right" class="sidebar">
        <div class="card card-firewall">
            <h2>Firewall Status</h2>
            <div id="firewall-content" style="padding-top: 5px;">
                <div style="text-align: center; color: #666;">Waiting for SNMP Data...</div>
            </div>
        </div>
        
        <div class="card card-hardware">
            <h2>Physical Hardware</h2>
            <div id="hardware-list" class="static-list"></div>
        </div>
        
        <div class="card card-nvr">
            <h2>NVRs</h2>
            <div id="nvr-list" class="static-list"></div>
        </div>

        <div class="card card-switch">
            <h2>Switch Hardware</h2>
            <div id="switch-window" class="list-window"><div id="switch-content" class="list-content"></div></div>
        </div>
        
        <div class="card card-printer">
            <h2>Printers</h2>
            <div id="printer-window" class="list-window"><div id="printer-content" class="list-content"></div></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }, 1000);

        const maps = [
            { id: 'T-G.PNG', name: 'T Site - Ground' }, { id: 'T-1.PNG', name: 'T Site - 1st Floor' },
            { id: 'T-M.PNG', name: 'T Site - Mezzanine' }, { id: 'K-G.PNG', name: 'K Site - Ground' },
            { id: 'K-1.PNG', name: 'K Site - 1st Floor' }, { id: 'K-2.PNG', name: 'K Site - 2nd Floor' }
        ];

        var map = L.map('map', { crs: L.CRS.Simple, minZoom: -2, zoomControl: false, attributionControl: false });
        var devicesLayer = L.layerGroup().addTo(map);
        var currentMapLayer;
        let currentMapIndex = 0;

        function loadMap(index) {
            const config = maps[index];
            document.getElementById('map-title').innerText = config.name;
            var img = new Image(); img.src = config.id;
            img.onload = function() {
                var w = this.width; var h = this.height;
                if (currentMapLayer) map.removeLayer(currentMapLayer);
                var bounds = [[0, 0], [h, w]]; 
                currentMapLayer = L.imageOverlay(config.id, bounds).addTo(map);
                map.fitBounds(bounds);
            }
        }

        class LoopScroller {
            constructor(windowId, contentId) {
                this.window = document.getElementById(windowId);
                this.content = document.getElementById(contentId);
                this.pos = 0; this.isPaused = false; this.start();
            }
            updateContent(html, hasAlert) {
                if (hasAlert) { this.isPaused = true; this.content.innerHTML = html; this.content.style.top = "0px"; return; } 
                this.isPaused = false;
                this.content.innerHTML = html;
                const singleHeight = this.content.offsetHeight; const windowHeight = this.window.offsetHeight;
                if (singleHeight === 0) return; 
                let repeatCount = Math.ceil((windowHeight + singleHeight) / singleHeight) + 1;
                let finalHTML = ""; for(let i=0; i<repeatCount; i++) finalHTML += html;
                this.content.innerHTML = finalHTML; this.singleBlockHeight = singleHeight;
            }
            start() {
                setInterval(() => {
                    if (this.isPaused || !this.singleBlockHeight) return;
                    this.pos -= 0.6; if (Math.abs(this.pos) >= this.singleBlockHeight) this.pos = 0;
                    this.content.style.top = this.pos + "px";
                }, 20); 
            }
        }

        const cloudS = new LoopScroller('cloud-window', 'cloud-content');
        const serverS = new LoopScroller('server-window', 'server-content');
        const switchS = new LoopScroller('switch-window', 'switch-content');
        const printerS = new LoopScroller('printer-window', 'printer-content');
        
        async function updateDashboard() {
            try {
                const res = await fetch('/api/devices');
                const devices = await res.json();
                
                let cloudH='', serverH='', hardwareH='', nvrH='', switchH='', prtH='';
                let cA=false, sA=false, swA=false, prtA=false;
                let firewallHTML = '';

                devices.sort((a, b) => a.name.localeCompare(b.name));

                devices.forEach(d => {
                    let statusClass = 'offline';
                    if (d.status === 'online') statusClass = 'online';
                    else if (d.status === 'amber') statusClass = 'amber';

                    const itemHTML = `<div class="service-item"><span>${d.name}</span><div class="status-dot ${statusClass}"></div></div>`;

                    if (d.type === 'service') { if (d.status !== 'online') cA=true; cloudH += itemHTML; } 
                    else if (d.type === 'server') { if (d.status !== 'online') sA=true; serverH += itemHTML; }
                    else if (d.type === 'hardware') { hardwareH += itemHTML; } 
                    else if (d.type === 'nvr') { nvrH += itemHTML; } 
                    else if (d.type === 'switch_hw') { if (d.status !== 'online') swA=true; switchH += itemHTML; }
                    else if (d.type === 'printer') { if (d.status !== 'online') prtA=true; prtH += itemHTML; }
                    
                    // FIREWALL DETAIL VIEW
                    else if (d.type === 'firewall') {
                        // Data from DB (saved by Agent)
                        const det = d.details || {};
                        const sysName = det.sysName || d.name;
                        const uptime = det.uptime || '--';
                        let desc = det.desc || 'No System Info';
                        
                        // Cleanup Description (Remove "Linux hostname" fluff)
                        desc = desc.replace(/^Linux\s+\S+\s+/, ''); 

                        firewallHTML += `
                            <div>
                                <div class="fw-row">
                                    <span class="fw-label">Device Name</span> 
                                    <span class="fw-val">${sysName}</span>
                                </div>
                                <div class="fw-row">
                                    <span class="fw-label">Status</span> 
                                    <div class="status-dot ${statusClass}"></div>
                                </div>
                                <div class="fw-row">
                                    <span class="fw-label">Uptime</span> 
                                    <span class="fw-val" style="color:#00d26a;">${uptime}</span>
                                </div>
                                <div class="fw-desc">
                                    ${desc}
                                </div>
                            </div>
                        `;
                    }
                });

                cloudS.updateContent(cloudH, cA);
                serverS.updateContent(serverH, sA);
                switchS.updateContent(switchH, swA);
                printerS.updateContent(prtH, prtA);

                document.getElementById('hardware-list').innerHTML = hardwareH;
                document.getElementById('nvr-list').innerHTML = nvrH;
                
                const fwContainer = document.getElementById('firewall-content');
                if (firewallHTML) fwContainer.innerHTML = firewallHTML;
                else fwContainer.innerHTML = '<div style="text-align: center; color: #666; font-size: 13px;">No Firewall Configured</div>';

                devicesLayer.clearLayers();
                devices.forEach(d => {
                    if (d.floor_id === maps[currentMapIndex].id && d.type === 'switch') {
                        let color = '#f8312f'; 
                        if (d.status === 'online') color = '#00d26a'; else if (d.status === 'amber') color = '#ffc107';
                        L.circleMarker([d.map_coordinates.y, d.map_coordinates.x], {
                            color: 'transparent', fillColor: color, fillOpacity: 0.9, radius: 8
                        }).addTo(devicesLayer).bindTooltip(d.name, {permanent: false, direction: 'top'});
                    }
                });

            } catch (e) { }

            try {
                const sRes = await fetch('/api/status');
                const speed = await sRes.json();
                document.getElementById('down-speed').innerText = (speed.download / 1000).toFixed(0) || '--';
            } catch (e) {}
        }

        setInterval(() => { currentMapIndex = (currentMapIndex + 1) % maps.length; loadMap(currentMapIndex); updateDashboard(); }, 15000); 
        loadMap(0); updateDashboard(); setInterval(updateDashboard, 5000); 
    </script>
</body>
</html>