<!DOCTYPE html>
<html>
<head>
    <title>KHS IT Monitor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #121212; display: flex; font-family: 'Inter', 'Segoe UI', sans-serif; overflow: hidden; height: 100vh; color: #e0e0e0; }
        .sidebar { width: 320px; background: #1e1e1e; display: flex; flex-direction: column; padding: 25px; box-shadow: 0 0 30px rgba(0,0,0,0.5); z-index: 2000; overflow-y: auto; scrollbar-width: none; }
        .sidebar::-webkit-scrollbar { display: none; }
        #sidebar-left { border-right: 1px solid #333; }
        #sidebar-right { border-left: 1px solid #333; }
        #main-content { flex-grow: 1; display: flex; flex-direction: column; background: #000; }

        .card { background: #252525; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; flex-direction: column; flex-shrink: 0; transition: all 0.3s ease; }
        
        .card-cloud { border-top: 3px solid #28a745; min-height: 100px; }
        .card-local { border-top: 3px solid #ffc107; }
        .card-firewall { border-top: 3px solid #fd7e14; }
        .card-hardware { border-top: 3px solid #e83e8c; } 
        .card-nvr { border-top: 3px solid #6f42c1; }      
        .card-switch { border-top: 3px solid #17a2b8; }     
        .card-printer { border-top: 3px solid #0d6efd; }   
        .card-telephone { border-top: 3px solid #00bcd4; }
        .card-wap { border-top: 3px solid #3f51b5; }
        .card-access { border-top: 3px solid #9c27b0; }
        .card-cctv { border-top: 3px solid #f44336; }

        /* Header with Toggle */
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .card h2 { margin: 0; font-size: 13px; color: #888; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; }
        .toggle-btn { cursor: pointer; font-size: 16px; opacity: 0.5; transition: opacity 0.2s; user-select: none; }
        .toggle-btn:hover { opacity: 1; }
        .toggle-btn.hidden-active { opacity: 0.3; filter: grayscale(100%); }

        .big-stat { font-size: 48px; font-weight: 300; color: #fff; letter-spacing: -2px; line-height: 1; }
        .unit { font-size: 13px; color: #666; font-weight: 500; margin-top: 5px; display: block; }
        
        /* List Window & Animation */
        .list-window { overflow-y: auto; padding-right: 5px; max-height: 320px; min-height: 30px; position: relative; scrollbar-width: none; transition: max-height 0.4s ease, opacity 0.4s ease; opacity: 1; }
        .list-window.minimized { max-height: 0; min-height: 0; opacity: 0; overflow: hidden; margin: 0; padding: 0; }
        .list-window::-webkit-scrollbar { display: none; }

        .service-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #333; font-size: 13px; color: #ccc; }
        .service-sub { font-size: 11px; color: #777; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        
        .status-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .online { background: #00d26a; box-shadow: 0 0 8px rgba(0, 210, 106, 0.4); }
        .amber { background: #ffc107; box-shadow: 0 0 8px rgba(255, 193, 7, 0.6); animation: pulse-amber 2s infinite; }
        .offline { background: #f8312f; box-shadow: 0 0 10px rgba(248, 49, 47, 0.6); animation: flash-red 0.8s infinite alternate; }

        @keyframes flash-green-amber {
            0% { background-color: #00d26a; box-shadow: 0 0 8px #00d26a; }
            50% { background-color: #ffc107; box-shadow: 0 0 8px #ffc107; }
            100% { background-color: #00d26a; box-shadow: 0 0 8px #00d26a; }
        }
        .flash-monitor { animation: flash-green-amber 2s infinite; }

        /* --- SERVER STATS BARS --- */
        .stat-container { margin-top: 6px; width: 100%; }
        .stat-row { display: flex; align-items: center; margin-bottom: 3px; }
        .stat-label { font-size: 10px; color: #888; width: 30px; }
        .stat-track { flex: 1; background: #333; height: 6px; border-radius: 3px; overflow: hidden; position: relative; }
        .stat-fill { height: 100%; width: 0%; transition: width 0.5s ease; border-radius: 3px; }
        .fill-cpu { background: #3498db; box-shadow: 0 0 5px rgba(52, 152, 219, 0.4); } 
        .fill-ram { background: #9b59b6; box-shadow: 0 0 5px rgba(155, 89, 182, 0.4); } 
        .fill-disk { background: #f1c40f; box-shadow: 0 0 5px rgba(241, 196, 15, 0.4); } 
        
        /* FIREWALL DATA */
        .fw-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; border-bottom: 1px solid #333; padding-bottom: 4px; }
        .fw-label { color: #888; }
        .fw-val { color: #fff; font-weight: 600; text-align: right; }

        /* ANIMATIONS */
        @keyframes pulse-amber { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        @keyframes flash-red { from { opacity: 1; box-shadow: 0 0 10px rgba(248, 49, 47, 0.8); } to { opacity: 0.3; box-shadow: 0 0 2px rgba(248, 49, 47, 0.2); } }

        /* HEADER & MAP LAYOUT */
        .page-header { background: rgba(30, 30, 30, 0.9); backdrop-filter: blur(10px); color: #fff; padding: 15px 30px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; z-index: 10; font-size: 20px; flex-shrink: 0; }
        .badge { font-size: 11px; font-weight: bold; padding: 5px 10px; border-radius: 4px; text-transform: uppercase; letter-spacing: 1px; margin-right: 15px; }
        .badge-local { background: rgba(0, 210, 106, 0.15); color: #00d26a; border: 1px solid #00d26a; }
        .badge-cloud { background: rgba(253, 126, 20, 0.15); color: #fd7e14; border: 1px solid #fd7e14; }

        #map-wrapper { flex-grow: 1; position: relative; width: 100%; height: 100%; }
        #map { height: 100%; width: 100%; background: #121212; }
        #map-title { position: absolute; top: 20px; right: 20px; background: rgba(20, 20, 20, 0.85); color: #e0e0e0; padding: 8px 20px; border-radius: 6px; z-index: 1000; backdrop-filter: blur(5px); border: 1px solid #444; }
        .version-footer { margin-top: auto; text-align: center; font-size: 11px; color: #444; padding-top: 20px; border-top: 1px solid #2a2a2a; }

        /* CONTROLS */
        #map-controls { position: absolute; bottom: 20px; right: 20px; z-index: 1000; display: flex; gap: 10px; }
        .control-btn { 
            background: rgba(20, 20, 20, 0.85); color: #e0e0e0; border: 1px solid #444; 
            padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; 
            backdrop-filter: blur(5px); transition: all 0.2s; display: flex; align-items: center; justify-content: center; 
        }
        .control-btn:hover { background: rgba(50, 50, 50, 0.9); border-color: #666; }
        .control-btn.paused { background: rgba(220, 53, 69, 0.8); border-color: #dc3545; color: white; }

        /* MAP ICONS */
        .custom-icon { font-size: 18px; text-align: center; line-height: 20px; transition: all 0.5s ease-in-out; }
        .glow-green { text-shadow: 0 0 10px #00d26a, 0 0 20px #00d26a; filter: drop-shadow(0 0 5px #00d26a); }
        .glow-amber { text-shadow: 0 0 10px #ffc107, 0 0 20px #ffc107; filter: drop-shadow(0 0 5px #ffc107); }
        .glow-red { text-shadow: 0 0 10px #f8312f, 0 0 20px #f8312f; filter: drop-shadow(0 0 5px #f8312f); }

        /* DARK POPUPS */
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #252525; color: #e0e0e0; border: 1px solid #444; box-shadow: 0 4px 15px rgba(0,0,0,0.6); border-radius: 8px; }
        .leaflet-popup-content { margin: 10px; line-height: 1.4; }
        .leaflet-popup-close-button { color: #888 !important; }

        /* --- MOBILE LAYOUT (<900px) --- */
        @media screen and (max-width: 900px) {
            body { flex-direction: column; overflow-y: auto; height: auto; padding-bottom: 50vh; }
            .sidebar { width: 100%; height: auto; box-shadow: none; padding: 10px; box-sizing: border-box; order: 2; overflow-y: visible; }
            #main-content { order: 1; flex-grow: 0; width: 100%; }
            #map-wrapper { display: block !important; position: fixed; bottom: 0; left: 0; width: 100%; height: 50vh; z-index: 4000; border-top: 4px solid #333; background: #121212; }
            .list-window { max-height: none; }
            .page-header { padding: 10px 15px; font-size: 16px; }
            .badge { display: none; }
        }
    </style>
</head>
<body>

    <div id="sidebar-left" class="sidebar">
        <div class="card card-firewall">
            <div class="card-header">
                <h2>Firewall & Internet</h2>
            </div>
            <div style="text-align: center; padding-bottom: 15px; border-bottom: 1px solid #333; margin-bottom: 10px;">
                <span class="big-stat" id="net-ping">--</span>
                <span class="unit" style="display:inline; margin-left:10px;">ms LATENCY</span>
            </div>
            <div id="firewall-content"></div>
        </div>
        
        <div class="card card-cloud">
            <div class="card-header">
                <h2>Cloud Services</h2>
                <span class="toggle-btn" onclick="toggleCard('service', 'cloud-window', this)">üëÅÔ∏è</span>
            </div>
            <div id="cloud-window" class="list-window"></div>
        </div>
        <div class="card card-local">
            <div class="card-header">
                <h2>Local Servers</h2>
                <span class="toggle-btn" onclick="toggleCard('server', 'server-window', this)">üëÅÔ∏è</span>
            </div>
            <div id="server-window" class="list-window"></div>
        </div>
        <div class="card card-nvr">
            <div class="card-header">
                <h2>NVRs & Cameras</h2>
                <span class="toggle-btn" onclick="toggleCard('nvr', 'nvr-list', this)">üëÅÔ∏è</span>
            </div>
            <div id="nvr-list" class="list-window"></div>
        </div>
        <div class="version-footer">KINGSBURY MONITOR v5.1</div>
    </div>

    <div id="main-content">
        <div class="page-header">
            <div style="display:flex; align-items:center;">
                <div id="conn-badge" class="badge badge-local">LOCAL</div>
                <span>Kingsbury IT Monitoring</span>
            </div>
            <span id="clock" style="font-size:14px; color:#888;"></span>
        </div>
        <div id="map-wrapper">
            <div id="map-title">Loading...</div>
            <div id="map-controls">
                <button class="control-btn" id="pause-btn" onclick="togglePause()">‚è∏Ô∏è Pause</button>
                <button class="control-btn" onclick="nextMap()">‚è≠Ô∏è Next</button>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <div id="sidebar-right" class="sidebar">
        <div class="card card-printer">
            <div class="card-header">
                <h2>Printers</h2>
                <span class="toggle-btn" onclick="toggleCard('printer', 'printer-window', this)">üëÅÔ∏è</span>
            </div>
            <div id="printer-window" class="list-window"></div>
        </div>
        
        <div class="card card-cctv">
            <div class="card-header">
                <h2>CCTV Cameras</h2>
                <span class="toggle-btn" onclick="toggleCard('cctv', 'cctv-list', this)">üëÅÔ∏è</span>
            </div>
            <div id="cctv-list" class="list-window"></div>
        </div>
        <div class="card card-switch">
            <div class="card-header">
                <h2>Switches</h2>
                <span class="toggle-btn" onclick="toggleCard('switch', 'switch-window', this)">üëÅÔ∏è</span>
            </div>
            <div id="switch-window" class="list-window"></div>
        </div>
        <div class="card card-wap">
            <div class="card-header">
                <h2>Wireless APs</h2>
                <span class="toggle-btn" onclick="toggleCard('wap', 'wap-list', this)">üëÅÔ∏è</span>
            </div>
            <div id="wap-list" class="list-window"></div>
        </div>
        <div class="card card-telephone">
            <div class="card-header">
                <h2>Telephones</h2>
                <span class="toggle-btn" onclick="toggleCard('telephone', 'tel-list', this)">üëÅÔ∏è</span>
            </div>
            <div id="tel-list" class="list-window"></div>
        </div>
        <div class="card card-access">
            <div class="card-header">
                <h2>Access Control</h2>
                <span class="toggle-btn" onclick="toggleCard('access_control', 'access-list', this)">üëÅÔ∏è</span>
            </div>
            <div id="access-list" class="list-window"></div>
        </div>
        <div class="card card-hardware">
            <div class="card-header">
                <h2>Misc Hardware</h2>
                <span class="toggle-btn" onclick="toggleCard('hardware', 'hardware-list', this)">üëÅÔ∏è</span>
            </div>
            <div id="hardware-list" class="list-window"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const isCloud = window.location.hostname.includes('render') || window.location.hostname.includes('herokuapp');
        const badge = document.getElementById('conn-badge');
        if (isCloud) { badge.innerText = "CLOUD VIEW"; badge.className = "badge badge-cloud"; }
        else { badge.innerText = "LOCAL VIEW"; badge.className = "badge badge-local"; }

        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }, 1000);

        // --- MAP SETUP ---
        const maps = [
            { id: 'T-G.PNG', name: 'T Site - Ground' }, { id: 'T-1.PNG', name: 'T Site - 1st Floor' },
            { id: 'T-M.PNG', name: 'T Site - Mezzanine' }, { id: 'K-G.PNG', name: 'K Site - Ground' },
            { id: 'K-1.PNG', name: 'K Site - 1st Floor' }, { id: 'K-2.PNG', name: 'K Site - 2nd Floor' }
        ];

        var map = L.map('map', { crs: L.CRS.Simple, minZoom: -2, zoomControl: false, attributionControl: false });
        var devicesLayer = L.layerGroup().addTo(map);
        var currentMapLayer;
        let currentMapIndex = 0;
        let isPaused = false;
        let mapTimer;

        // --- HIDE/SHOW LOGIC ---
        // Load preferences from Storage
        const hiddenTypes = new Set(JSON.parse(localStorage.getItem('hiddenTypes') || '[]'));

        function toggleCard(type, elementId, btn) {
            const el = document.getElementById(elementId);
            if(!el) return;

            if (hiddenTypes.has(type)) {
                // UNHIDE
                hiddenTypes.delete(type);
                el.classList.remove('minimized');
                if(btn) btn.classList.remove('hidden-active');
            } else {
                // HIDE
                hiddenTypes.add(type);
                el.classList.add('minimized');
                if(btn) btn.classList.add('hidden-active');
            }
            
            // Save preference
            localStorage.setItem('hiddenTypes', JSON.stringify([...hiddenTypes]));
            
            // Trigger Map Update to remove/add icons immediately
            updateDashboard();
        }

        // Apply initial hidden states on load
        window.addEventListener('DOMContentLoaded', () => {
            hiddenTypes.forEach(type => {
                // Map types to IDs manually for init (simplified)
                const map = {
                    'nvr': 'nvr-list', 'cctv': 'cctv-list', 'printer': 'printer-window', 
                    'switch': 'switch-window', 'wap': 'wap-list', 'telephone': 'tel-list', 
                    'access_control': 'access-list', 'hardware': 'hardware-list', 'server': 'server-window', 'service': 'cloud-window'
                };
                if(map[type]) {
                    const el = document.getElementById(map[type]);
                    if(el) el.classList.add('minimized');
                    // Find button near it (hacky but works for static HTML)
                    const btn = el.previousElementSibling?.querySelector('.toggle-btn');
                    if(btn) btn.classList.add('hidden-active');
                }
            });
        });

        // --- AUTO-SCROLL LOGIC ---
        let scrollStates = {}; 
        function startAutoScroll() {
            setInterval(() => {
                const lists = document.querySelectorAll('.list-window');
                lists.forEach(div => {
                    if (div.matches(':hover') || div.classList.contains('minimized')) return; // Skip if hidden
                    if (div.scrollHeight <= div.clientHeight) return;
                    
                    const id = div.id;
                    if (!scrollStates[id]) scrollStates[id] = { dir: 1, pause: 0 };
                    const state = scrollStates[id];

                    if (state.pause > 0) { state.pause -= 60; return; }
                    div.scrollTop += (state.dir * 1); 

                    if (Math.ceil(div.scrollTop + div.clientHeight) >= div.scrollHeight) {
                        state.dir = -1; state.pause = 3000; 
                    } else if (div.scrollTop <= 0) {
                        state.dir = 1; state.pause = 3000; 
                    }
                });
            }, 60); 
        }

        // --- MAP CONTROLS ---
        map.on('popupopen', function() { if(!isPaused) { togglePause(); document.getElementById('pause-btn').innerText = "‚ñ∂Ô∏è Resume (Reading)"; } });
        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('pause-btn');
            if(isPaused) { btn.innerText = "‚ñ∂Ô∏è Play"; btn.classList.add('paused'); }
            else { btn.innerText = "‚è∏Ô∏è Pause"; btn.classList.remove('paused'); updateDashboard(); }
        }
        function nextMap() {
            currentMapIndex = (currentMapIndex + 1) % maps.length;
            loadMap(currentMapIndex);
            const wasPaused = isPaused; isPaused = false; 
            updateDashboard().then(() => { isPaused = wasPaused; });
            clearInterval(mapTimer); startMapTimer();
        }
        function startMapTimer() {
            mapTimer = setInterval(() => { 
                if(!isPaused) { currentMapIndex = (currentMapIndex + 1) % maps.length; loadMap(currentMapIndex); updateDashboard(); }
            }, 15000);
        }
        function loadMap(index) {
            if (window.getComputedStyle(document.getElementById('map-wrapper')).display === 'none') return;
            const config = maps[index];
            document.getElementById('map-title').innerText = config.name;
            var img = new Image(); img.src = config.id; 
            img.onload = function() {
                var w = this.width; var h = this.height;
                if (currentMapLayer) map.removeLayer(currentMapLayer);
                var bounds = [[0, 0], [h, w]]; 
                currentMapLayer = L.imageOverlay(config.id, bounds).addTo(map);
                map.fitBounds(bounds);
            }
        }

        function getPopupContent(d) {
            const timeStr = d.updatedAt ? new Date(d.updatedAt).toLocaleTimeString() : "Just now";
            let statusColor = d.status === 'online' ? '#00d26a' : (d.status === 'amber' ? '#ffc107' : '#f8312f');
            let info = '';
            
            // CLEAN INFO FOR POPUP
            if(d.details) {
                if(d.type === 'nvr' || d.type === 'cctv') {
                    // Specific Camera Popup
                    if(d.details.sysName) info += `<div style="margin-top:6px; font-weight:bold; color:#fff;">${d.details.sysName}</div>`;
                    if(d.details.note) info += `<div style="font-size:10px; color:#aaa;">Firmware: ${d.details.note}</div>`;
                } else {
                    // Standard Popup
                    if(d.details.note) info = `<div style="margin-top:6px; font-style:italic; color:#ddd; font-weight:500;">"${d.details.note}"</div>`;
                    if(d.details.uptime) info += `<div style="margin-top:4px; font-size:10px; color:#aaa;">Uptime: ${d.details.uptime}</div>`;
                }
            }

            const safeName = d.name || 'Unknown';
            return `<div style="text-align:center; min-width: 140px;">
                    <div style="font-weight:700; font-size:14px; margin-bottom:4px; color:#fff;">${safeName}</div>
                    <div style="font-size:11px; color:#aaa; margin-bottom:6px;">${d.ip}</div>
                    <div style="background:${statusColor}; color:#000; padding:3px 8px; border-radius:4px; display:inline-block; font-weight:700; font-size:11px; text-transform:uppercase;">${d.status}</div>
                    ${info}
                    <div style="font-size:10px; color:#666; margin-top:10px; border-top:1px solid #444; padding-top:5px;">üïí Last Check: ${timeStr}</div></div>`;
        }

        async function updateDashboard() {
            // Capture scroll positions
            const scrollMap = {};
            document.querySelectorAll('.list-window').forEach(d => scrollMap[d.id] = d.scrollTop);

            try {
                const res = await fetch('/api/devices');
                let devices = await res.json();
                
                // 1. GHOST FILTER & SORT
                devices = devices.filter(d => d.name && d.name !== 'undefined');
                devices.sort((a, b) => (a.name || 'Unknown').localeCompare(b.name || 'Unknown'));
                
                let cloudH='', serverH='', hardwareH='', nvrH='', switchH='', prtH='', telH='', wapH='', accessH='', cctvH='';
                let firewallHTML = '';

                const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);

                devices.forEach(d => {
                    let statusClass = d.status === 'online' ? 'online' : (d.status === 'amber' ? 'amber' : 'offline');
                    
                    // RECOVERY FLASH
                    if (d.type !== 'printer' && d.status === 'online' && d.last_issue && new Date(d.last_issue) > oneDayAgo) {
                        statusClass = 'flash-monitor'; 
                    }

                    const dName = d.name || 'Unknown Device';

                    // --- STANDARD ITEM BUILDER ---
                    let itemHTML = `<div class="service-item"><span>${dName}</span><div class="status-dot ${statusClass}"></div></div>`;

                    // --- NVR / CAMERA SPECIFIC (CLEAN LAYOUT) ---
                    if (d.type === 'nvr' || d.type === 'cctv') {
                        // Logic: Name on top. Firmware/Model on bottom (small & grey). NO IP.
                        const firmware = d.details?.note || '';
                        const model = d.details?.sysName || '';
                        
                        // If we have a custom Name (e.g. "Main Hall"), show that.
                        // If not, show Model. 
                        // Subtext shows Firmware.
                        
                        let subText = firmware ? `${firmware}` : '';
                        
                        itemHTML = `
                        <div class="service-item">
                            <div style="display:flex; flex-direction:column; overflow:hidden;">
                                <span style="font-weight:600;">${dName}</span>
                                <div class="service-sub" style="color:#666;">${subText}</div>
                            </div>
                            <div class="status-dot ${statusClass}"></div>
                        </div>`;
                        
                        if(d.type === 'nvr') nvrH += itemHTML;
                        else cctvH += itemHTML;
                    }

                    // --- PRINTERS ---
                    else if (d.type === 'printer') {
                        let note = d.details?.note || '';
                        if (note && note.toLowerCase().includes('sleep')) statusClass = 'online';
                        let subHTML = (note && !['ready','online'].includes(note.toLowerCase())) ? `<div class="service-sub" style="color:#777">${note}</div>` : '';
                        itemHTML = `<div class="service-item"><div style="display:flex; flex-direction:column; overflow:hidden;"><span>${dName}</span>${subHTML}</div><div class="status-dot ${statusClass}"></div></div>`;
                        prtH += itemHTML;
                    }

                    // --- WAPs ---
                    else if (d.type === 'wap') {
                        let note = d.details?.note || '';
                        let subHTML = note ? `<div class="service-sub" style="color:#3498db; font-weight:600;">${note}</div>` : '';
                        itemHTML = `<div class="service-item"><div style="display:flex; flex-direction:column; overflow:hidden;"><span>${dName}</span>${subHTML}</div><div class="status-dot ${statusClass}"></div></div>`;
                        wapH += itemHTML;
                    }

                    // --- SERVERS ---
                    else if (d.type === 'server') {
                        let statsHTML = '';
                        if (d.details && d.details.cpu !== undefined) {
                            let cpu = parseInt(d.details.cpu)||0, ram = parseInt(d.details.ram)||0, disk = parseInt(d.details.disk)||0;
                            statsHTML = `
                            <div class="stat-container">
                                <div class="stat-row"><span class="stat-label">CPU</span><div class="stat-track"><div class="stat-fill fill-cpu" style="width:${cpu}%"></div></div></div>
                                <div class="stat-row"><span class="stat-label">RAM</span><div class="stat-track"><div class="stat-fill fill-ram" style="width:${ram}%"></div></div></div>
                                <div class="stat-row"><span class="stat-label">HDD</span><div class="stat-track"><div class="stat-fill fill-disk" style="width:${disk}%"></div></div></div>
                            </div>`;
                        } else {
                            statsHTML = `<div style="font-size:10px; color:#555; margin-top:3px; font-style:italic;">${d.status==='online'?'SNMP Unreachable':'Offline'}</div>`;
                        }
                        itemHTML = `<div class="service-item" style="flex-direction:column; align-items:stretch; padding:10px 0;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-weight:600;">${dName}</span>
                                <div class="status-dot ${statusClass}"></div>
                            </div>
                            ${statsHTML}
                        </div>`;
                        serverH += itemHTML;
                    }

                    // --- OTHERS ---
                    else if (d.type === 'service') cloudH += itemHTML;
                    else if (d.type === 'switch' || d.type === 'switch_hw') switchH += itemHTML; 
                    else if (d.type === 'telephone') telH += itemHTML;
                    else if (d.type === 'access_control') accessH += itemHTML;
                    else if (d.type === 'hardware' || d.type === 'san') hardwareH += itemHTML;
                    
                    // Firewall Special
                    else if (d.type === 'firewall') {
                        const det = d.details || {};
                        let statsHTML = '';
                        if (det.ram !== undefined) {
                            statsHTML = `<div class="stat-container" style="margin-top: 10px;">
                                <div class="stat-row"><span class="stat-label">RAM</span><div class="stat-track"><div class="stat-fill fill-ram" style="width:${det.ram}%"></div></div></div>
                                <div class="stat-row"><span class="stat-label">HDD</span><div class="stat-track"><div class="stat-fill fill-disk" style="width:${det.disk}%"></div></div></div>
                            </div>`;
                        }
                        firewallHTML += `<div style="margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px;">
                            <div class="fw-row"><span class="fw-label">Device</span><span class="fw-val">${det.sysName || dName}</span></div>
                            <div class="fw-row"><span class="fw-label">Status</span><div class="status-dot ${statusClass}"></div></div>
                            <div class="fw-row"><span class="fw-label">Uptime</span><span class="fw-val" style="color:#00d26a;">${det.uptime || '--'}</span></div>
                            ${statsHTML}
                        </div>`;
                    }
                });

                document.getElementById('cloud-window').innerHTML = cloudH;
                document.getElementById('server-window').innerHTML = serverH;
                document.getElementById('switch-window').innerHTML = switchH;
                document.getElementById('printer-window').innerHTML = prtH;
                document.getElementById('hardware-list').innerHTML = hardwareH;
                document.getElementById('nvr-list').innerHTML = nvrH;
                document.getElementById('tel-list').innerHTML = telH;
                document.getElementById('wap-list').innerHTML = wapH;
                document.getElementById('access-list').innerHTML = accessH;
                document.getElementById('cctv-list').innerHTML = cctvH;
                document.getElementById('firewall-content').innerHTML = firewallHTML || '<div style="text-align: center; color: #666; font-size: 13px;">No Firewall Configured</div>';

                // --- MAP ICONS UPDATE (RESPECT HIDDEN LAYERS) ---
                if (!isPaused && window.getComputedStyle(document.getElementById('map-wrapper')).display !== 'none') {
                    devicesLayer.clearLayers();
                    devices.forEach(d => {
                        // CHECK IF CATEGORY IS HIDDEN
                        if(hiddenTypes.has(d.type)) return;

                        if (!d.map_coordinates || typeof d.map_coordinates.x === 'undefined') return;
                        if (d.floor_id === maps[currentMapIndex].id) {
                            let glowClass = d.status === 'online' ? 'glow-green' : (d.status === 'amber' ? 'glow-amber' : 'glow-red');
                            let iconHTML = null;
                            if (d.type === 'printer') iconHTML = 'üñ®Ô∏è';
                            else if (d.type === 'telephone') iconHTML = '‚òè';
                            else if (d.type === 'wap') iconHTML = 'üì°'; 
                            else if (d.type === 'access_control') iconHTML = 'üîê';
                            else if (d.type === 'cctv') iconHTML = 'üìπ';
                            else if (d.type === 'nvr') iconHTML = 'üìº';

                            if (iconHTML) {
                                const icon = L.divIcon({ className: `custom-icon ${glowClass}`, html: iconHTML, iconSize: [25, 25], iconAnchor: [12, 12] });
                                L.marker([d.map_coordinates.y, d.map_coordinates.x], {icon: icon}).addTo(devicesLayer).bindTooltip(d.name || 'Unknown', {direction:'top'}).bindPopup(getPopupContent(d));
                            } else {
                                let color = d.status === 'online' ? '#00d26a' : (d.status === 'amber' ? '#ffc107' : '#f8312f');
                                L.circleMarker([d.map_coordinates.y, d.map_coordinates.x], { color: 'transparent', fillColor: color, fillOpacity: 0.9, radius: 8 }).addTo(devicesLayer).bindTooltip(d.name || 'Unknown', {permanent: false, direction: 'top'}).bindPopup(getPopupContent(d));
                            }
                        }
                    });
                }
            } catch (e) { console.log(e); }

            // Restore Scroll
            document.querySelectorAll('.list-window').forEach(d => {
                if(scrollMap[d.id] !== undefined) d.scrollTop = scrollMap[d.id];
            });

            try {
                const sRes = await fetch('/api/status');
                const speed = await sRes.json();
                document.getElementById('net-ping').innerText = speed.ping || '--';
                const pVal = parseInt(speed.ping);
                const pElem = document.getElementById('net-ping');
                pElem.style.color = pVal < 50 ? '#00d26a' : (pVal < 100 ? '#ffc107' : '#f8312f');
            } catch (e) {}
        }

        startMapTimer();
        startAutoScroll(); 
        loadMap(0); 
        updateDashboard(); 
        setInterval(updateDashboard, 5000); 
    </script>
</body>
</html>
